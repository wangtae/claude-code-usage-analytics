# Version 1.7.2

**Release Date:** 2025-11-26
**Focus:** Claude Code usage policy update - Sonnet limit support

## Overview

v1.7.2는 2025년 11월 24일 Claude의 usage limit 정책 변경에 대응하는 업데이트입니다. Opus cap이 제거되고 Sonnet에 별도 한도가 생긴 새로운 정책을 지원합니다.

## 주요 변경사항

### 1. Sonnet-only Limit Parsing Support

#### 1.1 Claude 정책 변경 내용
**변경 전 (~ 2025-11-23):**
- Current session
- Current week (all models)
- **Current week (Opus)** ← 별도 Opus 한도

**변경 후 (2025-11-24 ~):**
- Current session
- Current week (all models)
- **Current week (Sonnet only)** ← 별도 Sonnet 한도

**정책 설명:**
- ✅ Opus cap 제거: Opus 4.5를 전체 한도까지 사용 가능
- ✅ Sonnet 별도 한도: Sonnet에 독립적인 주간 한도 설정
- ✅ 한도 초기화: 모든 주간 한도가 Dec 2로 리셋됨

#### 1.2 정규식 패턴 업데이트

**문제점:**
- 기존 regex가 "Current week (Sonnet)"만 매칭
- 새로운 형식 "Current week (Sonnet only)"는 파싱 실패

**해결:**
- Regex 패턴을 `Current week \(Sonnet(?: only)?\)`로 수정
- "Current week (Sonnet)" 및 "Current week (Sonnet only)" 모두 매칭
- 하위 호환성 유지

**파일 변경:**
- `src/commands/limits.py` (107줄, 162줄, 165줄)

**변경 상세:**

**Before (Line 107):**
```python
if b'Current week (Sonnet)' in output and b'Esc to exit' in output:
```

**After (Line 107):**
```python
# Support both "Current week (Sonnet)" and "Current week (Sonnet only)"
if b'Current week (Sonnet' in output and b'Esc to exit' in output:
```

**Before (Line 162):**
```python
sonnet_match = re.search(r'Current week \(Sonnet\).*?(\d+)%\s+(used|left)',
                        clean_output, re.DOTALL)
```

**After (Line 162):**
```python
# Support both "Current week (Sonnet)" and "Current week (Sonnet only)"
sonnet_match = re.search(r'Current week \(Sonnet(?: only)?\).*?(\d+)%\s+(used|left)',
                        clean_output, re.DOTALL)
```

**Before (Line 165):**
```python
sonnet_reset_match = re.search(r'Current week \(Sonnet\).*?(\d+)%\s+(used|left).*?Resets\s+(.+?)(?:\r?\n|$)',
                              clean_output, re.DOTALL)
```

**After (Line 165):**
```python
sonnet_reset_match = re.search(r'Current week \(Sonnet(?: only)?\).*?(\d+)%\s+(used|left).*?Resets\s+(.+?)(?:\r?\n|$)',
                              clean_output, re.DOTALL)
```

#### 1.3 정규식 패턴 설명
- `(?: only)?` - non-capturing group으로 "only" 단어를 optional로 처리
- `?` - 0 또는 1회 매칭 (있어도 되고 없어도 됨)
- 기존 "Current week (Sonnet)" 형식과 완전 호환

### 2. 가격 정보 확인

#### 2.1 Opus 4.5 가격 (이미 반영됨)
- Input: $5.0 / MTok
- Output: $25.0 / MTok
- Cache write: $6.25 / MTok
- Cache read: $0.50 / MTok
- 출시일: 2025-11-24

#### 2.2 Haiku 4.5 가격 (이미 반영됨)
- Input: $1.0 / MTok
- Output: $5.0 / MTok
- Cache write: $1.25 / MTok
- Cache read: $0.10 / MTok
- 출시일: 2025-10-15

**가격 정보 위치:**
- `src/config/defaults.py` (45-52줄: Opus 4.5, 72-79줄: Haiku 4.5)

### 3. Dashboard 표시

#### 3.1 기존 표시 확인
Dashboard는 이미 "Current week (Sonnet)"으로 표시 중:
- `src/visualization/dashboard.py` (961줄, 1052줄)
- 추가 수정 불필요

## 버그 수정

- **[Fix]** "Current week (Sonnet only)" 형식 파싱 실패 문제 해결
- **[Fix]** Claude 정책 변경에 따른 usage 정보 읽기 오류 수정

## 개선 사항

- **[Improve]** 향후 Claude의 표시 형식 변경에 유연하게 대응
- **[Improve]** 정규식 패턴 유연성 향상

## 파일 변경 목록

```
src/commands/limits.py
  - Line 107: Sonnet 출력 감지 패턴 유연화
  - Line 162: sonnet_match 정규식 "only" 지원
  - Line 165: sonnet_reset_match 정규식 "only" 지원
```

## 업그레이드 노트

### 설치
```bash
pipx install -e . --force
```

### 호환성
- Python: 3.10+
- Claude Code: All versions
- 기존 데이터베이스: 영향 없음

### 주의사항
- 데이터베이스 컬럼명은 `sonnet_pct`로 유지 (기존 호환성)
- Sonnet limit 정보가 정상적으로 표시되는지 확인 필요

## 테스트 방법

1. `ccu` 실행
2. Settings → Usage 탭 확인
3. "Current week (Sonnet only)" 항목이 정상 표시되는지 확인
4. Reset 시간이 "Dec 2, 2pm (Asia/Seoul)" 형식으로 표시되는지 확인

## Known Issues

없음

## Next Steps

- 사용자 피드백 수집
- Claude Code 정책 변경 모니터링
