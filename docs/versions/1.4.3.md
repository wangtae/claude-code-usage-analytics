# Version 1.4.3

**Release Date**: 2025-10-24
**Type**: Feature Release (Gist Auto-Sync + Recommended Usage Fixes)

## 주요 변경사항

### 🆕 새로운 기능

#### 1. GitHub Gist 자동 동기화
- **자동 동기화 기능 추가**: 여러 기기 간 데이터 자동 동기화
- **설정 옵션**:
  - `gist_auto_sync`: 자동 동기화 활성화/비활성화 (기본값: 활성화)
  - `gist_sync_interval`: 동기화 주기 (기본값: 10분)
  - `gist_sync_mode`: 동기화 모드 (bidirectional/pull_only/push_only)
- **Dashboard Footer**: 실시간 동기화 상태 표시
  - "Gist: ✓ 2분 전" - 마지막 동기화 시간
  - "Gist: Syncing..." - 동기화 진행 중
  - "Gist: Not synced" - 동기화 안 됨
  - "Gist: ✗ Error" - 에러 발생
- **백그라운드 스레드**: 5초 후 첫 동기화, 이후 주기적 실행
- **Settings 메뉴 통합**:
  - `[l]` - 자동 동기화 활성화/비활성화 토글
  - `[m]` - 동기화 간격 조정 (분 단위)
  - `[n]` - 동기화 모드 선택

### 🔧 개선사항

#### 1. 권장 사용량 계산 개선
- **All models (week)**: 24시간 기준 권장 사용량
  - 주간 reset이 7일 후라도, 24시간 내 100% 사용 권장
  - 일관된 일일 사용 패턴 유도
  - 할당량 낭비 방지

- **Opus**: 7일 균등 분배 권장 사용량
  - Reset까지 남은 전체 기간에 균등 분배
  - 매 1분마다 권장량 증가 (0.0099%/분)
  - Exceeded 빨간색 바가 시간 지남에 따라 점진적 감소

#### 2. 실행 속도 최적화
- **5초 지연 동기화**: Dashboard가 즉시 표시되고, 5초 후 백그라운드 동기화
- **사용자 경험 개선**: 네트워크 작업으로 인한 실행 지연 제거

### 🐛 버그 수정

1. **Import 에러 수정**: `get_user_preference` → `load_user_preferences` 사용
2. **DateTime 에러 수정**: 중복 datetime import 제거
3. **권장 사용량 계산 수정**: 24시간 기준으로 변경

## 변경 상세

### Gist 자동 동기화 구현

**새 파일/함수**:
- `_gist_sync_thread()` - 백그라운드 동기화 스레드
- Footer 동기화 상태 표시
- Settings 메뉴 Gist 섹션 추가

**동작 방식**:
1. Dashboard 시작 시 5초 대기 (UI 먼저 표시)
2. Gist 토큰 설정되어 있으면 자동 pull 실행
3. 설정된 간격마다 주기적 동기화 (기본 10분)
4. 충돌 발생 시 auto-merge로 자동 해결

**타임라인**:
```
0초    → Dashboard 표시 (즉시)
5초    → 첫 자동 동기화 시작
5-8초  → 동기화 진행 (Footer: "Syncing...")
8초    → 동기화 완료 (Footer: "✓ Just now")
10분   → 주기적 동기화 시작
```

### 권장 사용량 계산 변경

#### Before (v1.4.2)
```python
# All models & Opus 모두 동일
week_start = reset_dt - timedelta(days=7)
recommended = (elapsed / (7 * 24 * 60)) * 100
```

**문제점**:
- Reset이 7일 후라도 week_start가 오늘이면 24시간 후 100%
- Opus reset 3일 후인데 이미 100% 사용 → 빨간색 안 나옴

#### After (v1.4.3)
```python
# All models: 24시간 기준
total_minutes = 24 * 60
recommended = (elapsed_minutes / 1440) * 100

# Opus: 7일 균등 분배
total_minutes = 7 * 24 * 60  # 10,080분
recommended = (elapsed_minutes / 10080) * 100
```

**개선 효과**:
- All models: 내일까지 100% 사용 권장 (명확한 일일 목표)
- Opus: Reset까지 점진적 사용 권장 (빨간색 바 시간 지남에 따라 감소)

### 예시: Opus 100% 사용, Reset 3일 전

| 시간 | 경과 | 권장% | 파란색 바 | 빨간색 바 |
|------|------|-------|----------|-----------|
| Day 1 00:00 | 0분 | 0.00% | 0% | **100%** ← 과도 사용 경고 |
| Day 1 10:00 | 600분 | 5.95% | 5.95% | **94.05%** |
| Day 2 00:00 | 14h | 14.29% | 14.29% | **85.71%** |
| Day 3 00:00 | 38h | 47.62% | 47.62% | **52.38%** |
| Reset Day | 72h | 100% | 100% | **0%** ← 정상 |

**매 1분마다 빨간색이 0.0099%씩 줄어듭니다!**

## 설정 방법

### Gist 자동 동기화 설정

```bash
# Dashboard 실행
ccu

# Settings 진입 (s 키)
# Gist Auto-Sync 섹션:
#   [l] - Auto-sync 토글 (기본: Enabled)
#   [m] - Interval 조정 (기본: 10분)
#   [n] - Mode 선택 (기본: Bidirectional)
```

### 동기화 모드 설명

1. **Bidirectional** (권장): Pull + Push
   - 다른 기기의 데이터 가져오기 + 내 데이터 업로드
   - 모든 기기 간 완전한 동기화

2. **Pull Only**: 다운로드만
   - 다른 기기의 데이터만 가져오기
   - 내 데이터는 업로드 안 함

3. **Push Only**: 업로드만
   - 내 데이터만 업로드
   - 다른 기기의 데이터 가져오지 않음

## Migration Guide

### v1.4.2 → v1.4.3

1. **자동 업그레이드**: 설정 자동 생성
   - `gist_auto_sync = "1"` (활성화)
   - `gist_sync_interval = "600"` (10분)
   - `gist_sync_mode = "bidirectional"`

2. **Gist 토큰 설정** (아직 안 했다면):
   ```bash
   ccu gist setup
   # 또는
   ccu gist set-token <your-token>
   ```

3. **권장 사용량 변경 확인**:
   - All models: 24시간 기준 (변경됨)
   - Opus: 7일 균등 분배 (새로운 계산)
   - 빨간색 exceeded 바 정상 표시 확인

## 기술 세부사항

### 파일 변경사항

**수정된 파일**:
- `src/config/defaults.py` - Gist 설정 추가
- `src/commands/usage.py` - 동기화 스레드 통합
- `src/visualization/dashboard.py` - Footer 상태 표시, 권장량 계산 개선
- `src/commands/settings.py` - Gist 섹션 추가

**새 함수**:
- `_gist_sync_thread()` - 백그라운드 동기화
- `_calculate_distributed_recommended_pct()` - Opus 균등 분배 계산

### 성능 영향

- **메모리**: 백그라운드 스레드 1개 추가 (~1MB)
- **네트워크**: 10분마다 GitHub API 호출 (소량)
- **실행 시간**: 5초 지연 동기화로 즉시 시작 (개선됨!)

## 알려진 제한사항

1. **수동 토큰 관리**: Gist 토큰 갱신 시 수동 재설정 필요
2. **충돌 해결**: 3회 재시도 후 실패 시 수동 해결 필요
3. **동기화 지연**: 최대 10분 간격 (설정 가능)

## 다음 버전 계획

- [ ] Gist 동기화 이력 표시
- [ ] 충돌 해결 UI 개선
- [ ] 동기화 에러 알림 강화
- [ ] 권장 사용량 커스터마이징

## Credits

이 버전은 다음 이슈들을 해결합니다:
- Gist 자동 동기화 요청
- 권장 사용량 계산 오류
- Opus exceeded 바 미표시 문제
- 실행 지연 문제

---

**Full Changelog**: https://github.com/wangtae/claude-code-usage-analytics/compare/v1.4.2...v1.4.3
