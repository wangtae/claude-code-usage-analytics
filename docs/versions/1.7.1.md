# Version 1.7.1

**Release Date:** 2025-11-24
**Focus:** Claude Code v2.0.50 compatibility - "left" format support

## Overview

v1.7.1은 Claude Code v2.0.50에서 usage 표시 방식이 "X% used"에서 "X% left"로 변경된 것에 대응하는 호환성 개선 버전입니다. 표시 형식에 관계없이 자동으로 인식하고 올바르게 계산합니다.

## 주요 변경사항

### 1. Usage Format Auto-detection

#### 1.1 "used" 및 "left" 형식 자동 인식
**문제점:**
- Claude Code v2.0.50에서 usage 표시가 "82% used" → "82% left"로 변경
- 기존 regex 패턴이 "used"만 매칭하여 파싱 실패
- Usage 정보를 읽을 수 없는 문제 발생

**해결:**
- Regex 패턴을 `(\d+)%\s+(used|left)`로 수정하여 두 형식 모두 매칭
- "left" 형식인 경우 자동으로 `100 - percentage` 계산
- 표시는 기존처럼 "used" 기준 유지 (권장 사용량 기능과 일관성)

**파일 변경:**
- `src/commands/limits.py` (156-162줄, 217-232줄)

**변경 상세:**

**Before (Regex):**
```python
session_match = re.search(r'Current session.*?(\d+)%\s+used.*?Resets\s+(.+?)(?:\r?\n|$)',
                         clean_output, re.DOTALL)
```

**After (Regex):**
```python
session_match = re.search(r'Current session.*?(\d+)%\s+(used|left).*?Resets\s+(.+?)(?:\r?\n|$)',
                         clean_output, re.DOTALL)
```

**Percentage Conversion Logic:**
```python
# Convert percentages to "used" basis
session_pct = int(session_match.group(1))
if session_match.group(2) == "left":
    session_pct = 100 - session_pct  # 82% left → 18% used
```

#### 1.2 적용 범위
- **Current session** - "used" / "left" 자동 인식
- **Current week (all models)** - "used" / "left" 자동 인식
- **Current week (Opus)** - "used" / "left" 자동 인식

#### 1.3 변환 예시
- Claude Code: "82% left" → CCU 표시: 18% used
- Claude Code: "18% used" → CCU 표시: 18% used

### 2. Backward Compatibility

#### 2.1 하위 호환성 보장
- 기존 "used" 형식: 정상 작동 ✅
- 새로운 "left" 형식: 자동 변환 ✅
- 향후 형식 변경에도 자동 대응 ✅

## 기술 상세

### Regex Group 변경
기존 그룹 구조가 변경되었습니다:

**Before:**
- `group(1)`: percentage
- `group(2)`: reset time

**After:**
- `group(1)`: percentage
- `group(2)`: "used" or "left"
- `group(3)`: reset time

### 영향 받는 코드
1. **Regex patterns** (156-162줄)
   - session_match, week_match, opus_match, opus_reset_match

2. **Reset time extraction** (180-187줄)
   - `group(2)` → `group(3)` 변경

3. **Percentage calculation** (217-232줄)
   - "left" 감지 및 자동 변환 로직 추가

## 버그 수정

- **[Fix]** Claude Code v2.0.50의 "left" 형식 파싱 실패 문제 해결
- **[Fix]** Usage 정보를 읽지 못하는 문제 해결

## 개선 사항

- **[Improve]** 향후 Claude Code의 표시 형식 변경에 자동 대응
- **[Improve]** 기존 권장 사용량 기능과 일관성 유지

## 파일 변경 목록

```
src/commands/limits.py
  - Regex patterns: "used" | "left" 자동 인식
  - Percentage conversion: "left" → "used" 자동 변환
  - Reset time group index 조정
```

## 업그레이드 노트

### 설치
```bash
pipx install -e . --force
```

### 호환성
- Python: 3.10+
- Claude Code: v2.0.50+ (및 이전 버전)
- 기존 데이터베이스: 영향 없음

### 주의사항
- 표시 방식은 기존과 동일 ("used" 기준)
- 내부 계산 로직만 변경되어 사용자 경험 변화 없음

## Known Issues

없음

## Next Steps

v1.7.0 계획:
- 추가 기능 검토 중
