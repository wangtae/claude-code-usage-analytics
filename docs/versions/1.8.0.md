# Version 1.8.0

**Release Date:** 2025-11-29
**Focus:** Gist Sync에 daily_snapshots 포함 - 전체 데이터 동기화 지원

## Overview

v1.8.0은 Gist 동기화 시 `daily_snapshots` 테이블을 포함하도록 개선한 버전입니다. 이전에는 `usage_records`만 export/import되어 기기 포맷 후 전체 히스토리 데이터가 복원되지 않는 문제가 있었습니다.

## 문제점

### 기존 동작의 한계

**데이터 저장 구조:**
- `usage_records`: 최근 상세 데이터만 저장 (오래된 데이터 삭제됨)
- `daily_snapshots`: 전체 기간의 집계 데이터 (절대 삭제 안 됨)

**문제 상황:**
1. 기기 A에서 3.8bn tokens 사용 (6개월간)
2. `usage_records`에는 216 records만 있음 (최근 데이터)
3. `daily_snapshots`에는 62일 분 전체 집계 데이터 있음
4. `ccu gist push --force` 실행 → 216 records만 업로드
5. 기기 포맷 후 gist pull → 최근 데이터만 복원, 전체 히스토리 손실

## 주요 변경사항

### 1. JSON Export에 daily_snapshots 추가

#### 1.1 export_to_json() 수정

**파일:** `src/sync/json_export.py`

**변경 내용:**
- `daily_snapshots` 테이블 데이터를 export 결과에 포함
- `since_date` 필터링 적용 (incremental export 지원)

```python
# Export daily_snapshots for full historical data sync
snapshots_query = """
    SELECT date, total_prompts, total_responses, total_sessions,
           total_tokens, input_tokens, output_tokens,
           cache_creation_tokens, cache_read_tokens, snapshot_timestamp
    FROM daily_snapshots
"""
if since_date:
    snapshots_query += " WHERE date >= ?"
snapshots_query += " ORDER BY date ASC"
```

#### 1.2 export_to_json_chunked() 수정

**변경 내용:**
- chunked export 시 `daily_snapshots`를 첫 번째 청크에만 포함
- `_export_period()`, `_export_chunked_by_count()` 함수 모두 업데이트

### 2. JSON Import에 daily_snapshots 추가

#### 2.1 import_from_json() 수정

**파일:** `src/sync/json_import.py`

**변경 내용:**
- `daily_snapshots` 데이터 import 로직 추가
- UPSERT (INSERT OR REPLACE) 사용하여 중복 방지 및 업데이트

```python
if "daily_snapshots" in json_data:
    for snapshot in json_data["daily_snapshots"]:
        cursor.execute("""
            INSERT OR REPLACE INTO daily_snapshots (
                date, total_prompts, total_responses, total_sessions,
                total_tokens, input_tokens, output_tokens,
                cache_creation_tokens, cache_read_tokens, snapshot_timestamp
            ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
        """, (...))
```

#### 2.2 Import 통계 확장

**변경 내용:**
- `new_snapshots`: 새로 추가된 snapshot 수
- `updated_snapshots`: 업데이트된 snapshot 수

### 3. Export 데이터 구조

**Before (v1.7.x):**
```json
{
  "machine_name": "HOME-WT",
  "export_date": "2025-11-29T...",
  "records": [...],
  "statistics": {...}
}
```

**After (v1.8.0):**
```json
{
  "machine_name": "HOME-WT",
  "export_date": "2025-11-29T...",
  "records": [...],
  "daily_snapshots": [
    {
      "date": "2025-09-21",
      "total_prompts": 150,
      "total_responses": 150,
      "total_sessions": 10,
      "total_tokens": 1500000,
      "input_tokens": 1000000,
      "output_tokens": 500000,
      "cache_creation_tokens": 0,
      "cache_read_tokens": 0,
      "snapshot_timestamp": "2025-09-21T23:59:59"
    },
    ...
  ],
  "statistics": {...}
}
```

## 파일 변경 목록

```
src/sync/json_export.py
  - export_to_json(): daily_snapshots export 추가
  - _export_period(): daily_snapshots export 추가
  - _export_chunked_by_count(): 첫 번째 청크에 daily_snapshots 포함

src/sync/json_import.py
  - import_from_json(): daily_snapshots import 추가 (UPSERT)
  - merge_multiple_exports(): snapshot 통계 집계 추가
  - dry_run 모드에서 daily_snapshots 검증 추가
```

## 업그레이드 노트

### 설치
```bash
pip install -e . --break-system-packages
# 또는
pipx install -e . --force
```

### 데이터 마이그레이션

**기존 사용자:**
1. v1.8.0으로 업그레이드
2. `ccu gist push --force` 실행 (전체 데이터 업로드)
3. 다른 기기에서 `ccu gist pull` 실행

**신규 기기:**
1. v1.8.0 설치
2. `ccu gist pull` 실행 → 전체 히스토리 복원

### 호환성

- Python: 3.10+
- 기존 데이터베이스: 완전 호환 (스키마 변경 없음)
- 이전 버전 Gist 데이터: daily_snapshots 없으면 records만 import

## 테스트 방법

```python
from src.sync.json_export import export_to_json
data = export_to_json(since_date=None)
print(f"Records: {len(data['records'])}")
print(f"Snapshots: {len(data.get('daily_snapshots', []))}")
```

## Known Issues

- `--force` 플래그가 전체 export를 트리거하지 않는 문제 → v1.8.1에서 수정

## Next Steps

- v1.8.1: `--force` 플래그 동작 수정
