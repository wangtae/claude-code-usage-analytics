# Version 1.3.7

**Release Date**: 2025-10-22

## Overview

이 버전은 Setup Wizard의 사용자 경험 개선과 Gist 설정 취소 시 발생하는 버그 수정에 초점을 맞춥니다. 사용자가 Gist 옵션을 선택했다가 취소하거나 토큰 입력에 실패했을 때, 다른 storage 옵션을 선택할 수 있도록 개선되었습니다.

## Bug Fixes

### 1. Gist Setup 취소 시 Storage 선택 복귀
**문제**: GitHub Gist 옵션 선택 후 토큰 입력 단계에서 Ctrl+C로 취소하면, storage 선택 화면으로 돌아가지 않고 OneDrive 방식으로 자동 진행되는 문제

**원인**: `_setup_gist_sync()`가 취소 시 `None`을 반환하는데, 이를 "전체 setup 취소"로 처리하여 잘못된 fallback 로직이 작동

**해결**:
```python
if gist_result is None:
    # User cancelled Gist setup - return to storage selection
    console.print("[yellow]Gist setup cancelled. Please select a different storage option.[/yellow]\n")
    return _select_database_location(console)  # Recursive call to restart selection
```

**효과**: Gist 설정 취소 시 명확한 메시지와 함께 Step 1 (storage 선택)으로 돌아감

### 2. 토큰 미입력 시 Storage 선택 복귀
**문제**: 사용자가 Gist를 선택했지만 토큰을 입력하지 않고 Enter만 누르면, local storage로 자동 진행

**변경 전**:
```python
if not token:
    console.print("[yellow]No token provided. Skipping Gist setup.[/yellow]")
    return False  # Skip → local storage로 진행
```

**변경 후**:
```python
if not token:
    console.print("[yellow]No token provided. Cannot proceed with Gist storage.[/yellow]")
    return None  # Cancel → storage 선택으로 복귀
```

**효과**: 사용자가 명시적으로 Gist를 선택했으므로, 토큰이 없으면 다른 옵션을 선택하도록 유도

### 3. 잘못된 토큰 입력 시 Storage 선택 복귀
**문제**: 잘못된 토큰을 입력하면 "Skipping Gist setup"으로 local storage로 진행

**변경 전**:
```python
if not client.test_token():
    console.print(" [red]✗ Invalid token[/red]")
    console.print("[yellow]Skipping Gist setup. You can retry with: ccu gist setup[/yellow]")
    return False
```

**변경 후**:
```python
if not client.test_token():
    console.print(" [red]✗ Invalid token[/red]")
    console.print("[yellow]Cannot proceed with Gist storage. Please select a different option.[/yellow]")
    return None
```

**효과**: 토큰 검증 실패 시에도 storage 선택으로 복귀하여 사용자가 다른 옵션 선택 가능

## Enhancements

### Setup Wizard의 Gist 보안 설명 추가
사용자가 Gist 옵션을 선택할 때 토큰 보안에 대한 자세한 설명 표시:

**Benefits 섹션에 Security 추가**:
```
Security:
  • Your GitHub token is automatically stored in OS keyring
  • Tokens are encrypted by your system (macOS Keychain, Windows Credential Manager, Linux Secret Service)
  • Fallback to secure file storage (permissions 600) if keyring unavailable
```

**토큰 입력 화면에 보안 안내**:
```
🔐 Your token will be securely stored in your system's keyring

Enter your GitHub token:
```

**토큰 저장 후 위치 표시**:
```
✓ Token saved securely
  Storage: System keyring (encrypted)
```

### 메시지 명확화
'n' (skip) 선택 시 메시지 개선:
```python
# Before
console.print("[yellow]Skipping Gist setup[/yellow]")
console.print("[dim]You can configure it later with: ccu gist setup[/dim]")

# After
console.print("[yellow]Skipping Gist setup - using local storage instead[/yellow]")
console.print("[dim]You can add Gist backup later with: ccu gist setup[/dim]")
```

## User Experience Flow

### Before (v1.3.6)
```
1. User selects "GitHub Gist"
2. User presses Ctrl+C during token input
3. ❌ Setup proceeds with OneDrive storage (unexpected)
```

```
1. User selects "GitHub Gist"
2. User presses Enter (no token)
3. ❌ Setup proceeds with local storage (silent fallback)
```

### After (v1.3.7)
```
1. User selects "GitHub Gist"
2. User presses Ctrl+C during token input
3. ✅ "Gist setup cancelled. Please select a different storage option."
4. ✅ Returns to Step 1 (storage selection)
5. User can select Local, OneDrive, or Custom Path
```

```
1. User selects "GitHub Gist"
2. User presses Enter (no token)
3. ✅ "No token provided. Cannot proceed with Gist storage."
4. ✅ Returns to Step 1 (storage selection)
```

```
1. User selects "GitHub Gist"
2. User presses 'n' (skip)
3. ✅ "Skipping Gist setup - using local storage instead"
4. ✅ Proceeds to Step 2 with local storage (as intended)
```

## Technical Changes

### Files Modified

1. **`src/commands/setup_wizard.py`**
   - Line 193-196: Gist cancellation now returns to storage selection (recursive call)
   - Line 234-237: Added Security section to Benefits display
   - Line 288: Added token security message before input
   - Line 299-300: Empty token returns None (cancel) instead of False (skip)
   - Line 312-313: Invalid token returns None instead of False
   - Line 317-318: Validation error returns None instead of False
   - Line 260-261: Clarified skip message ("using local storage instead")
   - Line 322-323: Shows storage location after token is saved

2. **`pyproject.toml`**
   - Version: 1.3.6 → 1.3.7

3. **`src/commands/usage.py`**
   - Line 59: Version string updated to "1.3.7"

## Return Value Semantics

`_setup_gist_sync()` 반환값의 의미:

| Return Value | Meaning | Next Action |
|--------------|---------|-------------|
| `True` | Gist setup 성공 | Step 2로 진행 (local DB + Gist backup) |
| `False` | Skip (사용자가 'n' 선택) | Step 2로 진행 (local DB only) |
| `None` | Cancel (Ctrl+C, 토큰 없음, 잘못된 토큰) | Step 1로 복귀 (storage 재선택) |

## Breaking Changes

**None**. 기존 동작은 유지되며, 버그만 수정됨.

## Migration Guide

마이그레이션 불필요. 기존 설치는 계속 작동.

새 설치 시:
- Gist 설정 취소가 더 직관적으로 작동
- 토큰 문제 발생 시 다른 storage 옵션 선택 가능

## Use Cases

### Case 1: Gist 선택했지만 토큰이 없음
```
User: "Gist를 사용하고 싶지만 지금 토큰이 없네..."
Before: Local storage로 자동 진행 (혼란)
After: Storage 선택으로 복귀 → OneDrive나 Local 선택 가능
```

### Case 2: Gist 토큰 입력 중 실수로 Ctrl+C
```
User: "앗, 잘못 눌렀는데..."
Before: OneDrive로 자동 진행 (예상 밖)
After: Storage 선택으로 복귀 → 다시 Gist 선택 가능
```

### Case 3: Gist 토큰이 만료되었거나 잘못됨
```
User: "토큰이 안 맞네..."
Before: Local storage로 자동 진행
After: Storage 선택으로 복귀 → 새 토큰 준비 후 다시 시도하거나 다른 옵션 선택
```

### Case 4: 지금은 Gist 설정 안 하고 나중에 하기
```
User: "나중에 설정할래"
Before: 'n' 선택 → Local storage (의도된 동작)
After: 'n' 선택 → Local storage (동일, 메시지만 명확해짐)
```

## Testing Recommendations

1. **Gist 취소 테스트**:
   ```
   1. Run ccu (first time)
   2. Select "GitHub Gist"
   3. Press Ctrl+C during token input
   4. Verify: Returns to Step 1 (storage selection)
   5. Select different option (Local/OneDrive)
   6. Verify: Setup completes successfully
   ```

2. **토큰 미입력 테스트**:
   ```
   1. Run ccu (first time)
   2. Select "GitHub Gist"
   3. Press 'y' (yes, setup now)
   4. Press Enter (no token)
   5. Verify: Returns to Step 1
   6. Select Local storage
   7. Verify: Setup completes with local storage
   ```

3. **잘못된 토큰 테스트**:
   ```
   1. Run ccu (first time)
   2. Select "GitHub Gist"
   3. Press 'y'
   4. Enter invalid token (e.g., "abc123")
   5. Verify: "Invalid token" error
   6. Verify: Returns to Step 1
   7. Select OneDrive
   8. Verify: Setup completes with OneDrive
   ```

4. **Skip 테스트** (기존 동작 확인):
   ```
   1. Run ccu (first time)
   2. Select "GitHub Gist"
   3. Press 'n' (skip)
   4. Verify: "using local storage instead"
   5. Verify: Proceeds to Step 2
   6. Verify: Setup completes with local storage
   ```

## Known Issues

None reported.

## Compatibility

- **Python**: 3.10+
- **Dependencies**: No changes
- **Platforms**: Linux (WSL2), macOS, Windows (native)

## Future Improvements

- Add "retry token input" option instead of returning to storage selection
- Remember last selected storage option if user cancels and retries
- Add token validation preview before full setup
- Allow editing token in Settings menu
