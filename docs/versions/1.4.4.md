# Version 1.4.4 Release Notes

**Release Date**: 2025-01-24
**Type**: Bug Fix & UX Improvement
**Priority**: Recommended Update

## Overview

Version 1.4.4 fixes critical cost calculation issues and significantly improves Gist synchronization user experience. This release ensures costs display only for the current reset period (not cumulative history) and makes initial sync behavior clear and immediate.

---

## 🐛 Bug Fixes

### Cost Calculation Corrections

**Issue**: Cost calculations showed cumulative totals instead of current period amounts
- Example: 3% usage displayed $556.15 (entire history) instead of ~$16.68 (current period)
- Root cause: Functions used fixed time periods (5 hours, 7 days) instead of parsing actual reset times

**Fix**: Parse reset time strings to calculate exact period boundaries
- `_calculate_session_cost()`: Now parses "2h 30m" format to find session start
- `_calculate_weekly_sonnet_cost()`: Parses "Oct 31, 9:59am" to find week start
- `_calculate_weekly_opus_cost()`: Parses Opus reset time separately

**Supported Date Formats**:
```python
"Oct 31, 9:59am (Asia/Seoul)"  # Full date with timezone
"10/31 9:59am"                 # Numeric date format
"9:59am"                       # Time-only (uses today's date)
"2h 30m"                       # Elapsed time format
```

**Result**:
- Current session: Shows cost since last session reset (not last 5 hours)
- Current week: Shows cost since week reset (not last 7 days)
- Opus week: Shows cost since opus reset (not last 7 days)

**Files Modified**:
- `src/visualization/dashboard.py` - Cost calculation functions with reset time parsing

**Commits**:
- `51f1b18` - Fix: Calculate costs based on reset times instead of fixed periods
- `c6eca08` - Fix: Parse reset times correctly for cost calculations and add next sync time display

---

## ✨ Features & Improvements

### Synchronous Initial Gist Sync

**Before**: Background sync after 5-second delay
- Dashboard showed "Gist: Not synced (다음: 5초 후)"
- User confusion: "Is sync broken?"
- Data from other devices not immediately available

**After**: Synchronous sync during startup with clear feedback
- Spinner: "Syncing with GitHub Gist..."
- Success message: "✓ Gist sync: 127 new records pulled"
- Dashboard loads with latest data already synced

**Startup Sequence**:
1. Fetch usage limits (spinner)
2. **Sync with Gist (spinner)** ← NEW
3. Display dashboard (with fresh data)
4. Start background threads

**Benefits**:
- ✅ Immediate visibility into sync status
- ✅ Latest data from other machines on first load
- ✅ Clear error messages before dashboard loads
- ✅ No confusing countdown timers

**Files Modified**:
- `src/commands/usage.py` - Moved initial sync from background thread to startup

**Commits**:
- `1c010ea` - Feat: Perform initial Gist sync synchronously on startup

---

### Next Sync Time Display

**Feature**: Show countdown to next Gist synchronization

**Footer Display Examples**:
```
Gist: Not synced (다음: 3초 후)          # Waiting for first sync
Gist: Syncing... ◼                       # Sync in progress
Gist: ✓ Just now (다음: 10분 후)        # Recently synced
Gist: ✓ 5분 전 (다음: 5분 후)           # 5 min ago, 5 min until next
Gist: ✗ Error                            # Sync failed
```

**Time Formats**:
- Less than 60 seconds: "X초 후"
- Less than 60 minutes: "X분 후"
- Over 60 minutes: "X시간 Y분 후"

**Implementation**:
- `sync_status_ref['next_sync']` stores datetime of next sync
- Updated after every sync (success or failure)
- Initialized on startup: `now + interval` (default 10 minutes)

**Files Modified**:
- `src/commands/usage.py` - Track next_sync timestamp
- `src/visualization/dashboard.py` - Display next sync countdown

**Commits**:
- `c6eca08` - Fix: Parse reset times correctly for cost calculations and add next sync time display
- `0ac37d1` - Fix: Show next sync time immediately on startup to avoid confusion

---

## 🔧 Technical Details

### Cost Calculation Algorithm

**Week Start Calculation** (for `_calculate_weekly_sonnet_cost`):
```python
# Parse reset string: "Oct 31, 9:59am (Asia/Seoul)"
reset_dt = parse_reset_time(week_reset_str)  # Oct 31, 9:59am
week_start = reset_dt - timedelta(days=7)    # Oct 24, 9:59am

# Filter records
cost = sum(
    calculate_cost(record)
    for record in records
    if record.timestamp >= week_start
)
```

**Session Start Calculation** (for `_calculate_session_cost`):
```python
# Parse reset string: "2h 30m ($45.12)"
elapsed_minutes = parse_elapsed_time("2h 30m")  # 150 minutes
session_start = now - timedelta(minutes=elapsed_minutes)

# Filter records
cost = sum(
    calculate_cost(record)
    for record in records
    if record.timestamp >= session_start
)
```

### Sync Status Reference Structure

```python
sync_status_ref = {
    'last_sync': datetime | None,      # Last successful sync time
    'next_sync': datetime,             # Next scheduled sync time
    'is_syncing': bool,                # Currently syncing
    'error': str | None,               # Last error message
}
```

**Update Flow**:
1. Startup: Initialize with `next_sync = now + interval`
2. Sync starts: Set `is_syncing = True`
3. Sync completes: Update `last_sync`, `next_sync`, clear `error`
4. Sync fails: Update `next_sync`, set `error` message
5. Dashboard: Display status based on current state

---

## 📊 Impact Analysis

### Cost Display Accuracy

**Scenario**: Week reset 1 hour ago, 3% usage
- **Before**: $556.15 (cumulative since database creation)
- **After**: $16.68 (3% of weekly quota cost)
- **Improvement**: 97% reduction in displayed cost (accurate current period)

### User Experience

**Startup Time**:
- Before: 0s (dashboard loads immediately, sync in background)
- After: 1-5s (waits for initial sync to complete)
- Trade-off: Slightly slower startup for guaranteed fresh data

**Sync Visibility**:
- Before: "Not synced" → 5s wait → background sync (invisible)
- After: Spinner → success message → dashboard with synced data
- Improvement: 100% visibility into sync status

---

## 🚀 Migration Guide

### No Breaking Changes

This release is fully backward compatible. No configuration changes required.

### What to Expect

**First Run After Update**:
1. **New spinner message**: "Syncing with GitHub Gist..."
2. **Sync result message**: "✓ Gist sync: X new records pulled"
3. **Footer change**: "✓ Just now (다음: 10분 후)" instead of "Not synced"

**Cost Display Changes**:
- Session cost: May be lower (correct period-based calculation)
- Weekly cost: May be significantly lower if reset recently
- Opus cost: May differ due to separate reset time

If you see drastically different costs, this is **expected and correct** - previous versions showed cumulative totals incorrectly.

---

## 📝 Configuration

### Gist Sync Settings (Unchanged)

```bash
# View current settings
ccu config show

# Sync interval (seconds)
ccu config set-preference gist_sync_interval 600  # 10 minutes (default)

# Sync mode
ccu config set-preference gist_sync_mode bidirectional  # pull+push
ccu config set-preference gist_sync_mode pull_only      # read-only
ccu config set-preference gist_sync_mode push_only      # write-only

# Enable/disable auto-sync
ccu config set-preference gist_auto_sync 1  # enabled (default)
ccu config set-preference gist_auto_sync 0  # disabled
```

---

## 🧪 Testing

### Cost Calculation Verification

**Test Case 1**: Session reset 1 hour ago
```bash
# Expected: Cost for last 1 hour only
# Before: Cost for last 5 hours
# Verify: Check "Current session" cost matches recent usage
```

**Test Case 2**: Week reset 2 days ago, 30% usage
```bash
# Expected: ~30% of total weekly quota cost
# Before: Cumulative cost since first record
# Verify: Cost proportional to usage percentage
```

**Test Case 3**: Opus reset different from week reset
```bash
# Expected: Separate cost calculation for Opus
# Verify: "Current week (Opus)" cost independent of "Current week (all models)"
```

### Sync Behavior Verification

**Test Case 1**: First startup with token configured
```bash
ccu
# Expected output:
# [Spinner] Syncing with GitHub Gist...
# ✓ Gist sync: X new records pulled
# [Dashboard loads]
# Footer: Gist: ✓ Just now (다음: 10분 후)
```

**Test Case 2**: Startup with no token
```bash
ccu
# Expected: Silent skip, no sync message
# Footer: Gist: Not synced (다음: 10분 후)
```

**Test Case 3**: Startup with sync disabled
```bash
ccu config set-preference gist_auto_sync 0
ccu
# Expected: No sync, no message
# Footer: No Gist status shown
```

---

## 🐛 Known Issues

### None Reported

This release focuses on bug fixes and UX improvements. No new issues introduced.

---

## 📚 Documentation Updates

### Updated Files

- `README.md` - No changes (feature behavior, not usage)
- `CLAUDE.md` - Updated cost calculation and sync flow descriptions
- This release note (`docs/versions/1.4.4.md`)

### Code Documentation

**New Function Comments**:
- `_calculate_session_cost()` - Documents reset string parsing logic
- `_calculate_weekly_sonnet_cost()` - Explains "all models" despite function name
- `_calculate_weekly_opus_cost()` - Clarifies Opus-only filtering

---

## 🔗 Related Issues

### Fixed Issues

1. **Cost calculation showing cumulative totals** (User report: 2025-01-24)
   - Symptom: $556.15 for 3% usage
   - Fix: Parse reset times instead of using fixed periods

2. **Confusing "Not synced" status on startup** (User report: 2025-01-24)
   - Symptom: "Gist: Not synced" without context
   - Fix: Show countdown timer immediately

3. **No visibility into sync progress** (User request: 2025-01-24)
   - Symptom: Background sync with no feedback
   - Fix: Synchronous sync with spinner and success message

---

## 👥 Contributors

- **Claude** (claude-sonnet-4-5-20250929) - Implementation
- **wangt** - Issue reporting, requirements, testing

---

## 📦 Upgrade Instructions

### From 1.4.3 to 1.4.4

```bash
# Pull latest code
git fetch origin
git checkout develop
git pull origin develop

# Install updated version
pipx install -e .

# Verify version
ccu --version  # Should show 1.4.4

# Test cost display
ccu  # Check that costs match current period usage

# Test sync behavior
ccu  # Should see sync spinner and success message
```

### Rollback Instructions

```bash
# If issues occur, rollback to 1.4.3
git checkout v1.4.3
pipx install -e .
```

---

## 🔮 Future Improvements

### Potential Enhancements

1. **Sync timeout**: Add max wait time for slow networks (30s timeout)
2. **Partial sync progress**: Show "Syncing... (2/5 machines)" for multi-device setups
3. **Cost breakdown**: Display cost per model in tooltip
4. **Reset time validation**: Warn if parsed reset time seems incorrect

### User Feedback Welcome

Please report any issues or suggestions:
- GitHub Issues: https://github.com/anthropics/claude-code-usage-analytics/issues
- Via Claude Code: Provide feedback directly during usage

---

## 📄 Changelog Summary

```
v1.4.4 (2025-01-24)
-------------------

Fixed:
  - Cost calculations now use reset times instead of fixed periods
  - Session cost: Parse "Xh Ym" format to find actual session start
  - Weekly cost: Parse reset date to find week start (not last 7 days)
  - Opus cost: Separate reset time parsing for accurate Opus-only calculation

Added:
  - Synchronous Gist sync on startup with spinner feedback
  - Next sync time countdown in footer: "다음: X분 후"
  - Success message: "✓ Gist sync: X new records pulled"
  - Error visibility before dashboard loads

Changed:
  - Startup sequence: sync now happens before dashboard display
  - Background sync thread: removed initial 5-second sync (done at startup)
  - Footer display: Always shows next sync time when scheduled

Technical:
  - Support multiple date formats: "Oct 31, 9:59am", "10/31 9:59am", "9:59am"
  - Timezone-aware reset time parsing with ZoneInfo
  - sync_status_ref includes next_sync timestamp
  - Improved error handling for sync failures
```

---

## 🏆 Version Comparison

| Metric | v1.4.3 | v1.4.4 | Change |
|--------|--------|--------|--------|
| Cost Accuracy | Cumulative | Period-based | ✅ Correct |
| Sync Visibility | Background | Foreground | ✅ Clear |
| Startup Time | Instant | 1-5s | ⚠️ Slightly slower |
| Next Sync Display | ❌ No | ✅ Yes | ✅ Added |
| Error Feedback | After load | Before load | ✅ Improved |

---

**End of Release Notes**
