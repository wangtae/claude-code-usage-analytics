# Version 1.2.6

**Release Date**: 2025-10-19

## 🎉 Major Improvements

### Claude Code SDK Compatibility
Fixed compatibility issues with the new Claude Code SDK (v2.0.22+), ensuring seamless operation across both SDK and legacy versions.

## 🐛 Bug Fixes

### Usage Limits Not Updating on Startup
- **Issue**: Program displayed stale usage data (20+ hours old) instead of fetching fresh data on startup
- **Root Cause**:
  1. Trust prompt format changed in SDK version (numbered menu instead of y/n)
  2. Insufficient timeout for data loading (10s → need 20s+)
  3. No automatic trust prompt acceptance
- **Solution**:
  - Auto-accept trust prompts for both SDK and legacy versions
  - Increased timeout from 10s to 20s
  - Added "Loading usage data" detection with timer reset
  - Execute `claude /usage` synchronously on startup before dashboard display

### Changes Made

#### [src/commands/limits.py](../../src/commands/limits.py)
- Added dual trust prompt detection:
  - SDK format: "Yes, continue" → Enter key
  - Legacy format: "Do you trust" → `y` key
- Increased max_wait from 10s to 20s
- Added loading state detection with timer reset
- Run from home directory to minimize trust prompts
- Added debug output to temp file for troubleshooting

#### [src/commands/usage.py](../../src/commands/usage.py)
- Added synchronous `capture_limits()` call on program startup
- Display status message: "Fetching latest usage limits..."
- Added debug messages for success/failure states
- 2-second pause after fetch to show debug messages
- Applied to both refresh mode and watch mode

#### [pyproject.toml](../../pyproject.toml)
- Renamed package from `claude-goblin-mod` to `claude-code-usage-analytics`
- Updated repository URLs
- Removed `claude-goblin` command alias (kept `ccu` only)
- Updated description and authors

## 🔧 Technical Details

### Trust Prompt Auto-Accept Flow
```python
# Detect SDK format
if b'Yes, continue' in output or b'Ready to code here?' in output:
    os.write(master, b'\r')  # Press Enter

# Detect legacy format
elif b'Do you trust' in output:
    os.write(master, b'y\r')  # Type 'y'
```

### Loading Detection with Timer Reset
```python
if not loading_detected and b'Loading usage data' in output:
    loading_detected = True
    start_time = time.time()  # Reset timer for additional 20s wait
```

### Startup Flow
1. Program starts → keyboard listener starts
2. Execute `capture_limits()` **synchronously** (blocks until complete)
3. Display debug message (success/failure)
4. Wait 2 seconds for user to see message
5. Start background limits updater thread
6. Display dashboard with fresh data

## 📊 Performance Impact

- **Startup time**: +5-7 seconds (one-time `claude /usage` execution)
- **Data freshness**: 100% (always shows latest data on startup)
- **Background updates**: Every 60 seconds (configurable with `--limits-interval`)

## 🔄 Compatibility

- ✅ Claude Code SDK v2.0.22+
- ✅ Claude Code legacy versions
- ✅ Multi-device sync via OneDrive
- ✅ WSL2 environment

## 📝 Breaking Changes

### Package Name Change
- **Old**: `pipx install claude-goblin-mod`
- **New**: `pipx install claude-code-usage-analytics`

Migration:
```bash
pipx uninstall claude-goblin-mod
pipx install claude-code-usage-analytics
```

### Command Changes
- Removed: `claude-goblin` command
- Kept: `ccu` command (unchanged)

## 🙏 Credits

Thanks to @wangtae for identifying the SDK compatibility issue and providing detailed debugging information.
