# Version 1.2.1

Released: 2025-10-17

## Major Features

### Improved Heatmap Visualization

#### Device Heatmap Enhancements
- **Table-Based Layout**: Converted device heatmap to Rich Table structure for better alignment
  - Month number headers at the top
  - Day names (Mon-Sun) in the first column
  - Each hour (00-23) as individual columns
- **5-Step Opacity Gradient**: Simplified color intensity levels for clearer visualization
  - 0%: No usage (dark background)
  - 20%: Low usage
  - 40%: Medium-low usage
  - 60%: Medium-high usage
  - 80%: High usage
  - 100%: Maximum usage (full color)
- **Color-Only Display**: Removed text characters from cells, showing pure background color gradient
- **Device-Specific Colors**: Each device gets a unique color for easy distinction
  - Orange, Cyan, Pink, Green, Purple, Yellow, Red, Teal
- **Haiku Model Exclusion**: Background Claude Code sub-agent requests no longer appear in device statistics

#### Yearly Heatmap Improvements
- **Table-Based Layout**: Migrated from Unicode block characters (■) to Rich Table format
  - Month numbers as column headers
  - Day names (Sun-Sat) as row labels
- **Square Cell Design**: Adjusted cell width and padding for balanced square appearance
  - Column width: 2 characters
  - Cell content: 2 spaces with background color
- **Consistent Color Gradients**: Applied same 5-step opacity system as device heatmap

### Data Accuracy Improvements
- **Precise Gradient Calculation**: Maintains actual usage ratio for accurate color representation
  - 1-20% → 20% opacity
  - 21-40% → 40% opacity
  - 41-60% → 60% opacity
  - 61-80% → 80% opacity
  - 81-100% → 100% opacity
- **Color Blending Formula**: Uses proper RGB interpolation for smooth gradients
  - Formula: `bg_val + (color_val - bg_val) * opacity_factor`
  - Background: grey15 (rgb(38,38,38))
  - Foreground: Device-specific color

## Technical Details

### New Functions
- `get_device_hourly_distribution(machine_name, week_offset)`: Fetch hourly usage distribution per device
  - Returns dictionary mapping (day_of_week, hour) to token count
  - Excludes Haiku model requests
  - Uses local timezone conversion for display
- `get_device_statistics_for_period(period)`: Get device stats filtered by time period
  - Supports "all", "monthly", "weekly" periods
  - Returns list of device statistics dictionaries

### Modified Functions
- `_render_device_heatmaps()`: Generate weekly hourly heatmap tables for each device
- `_create_weekly_heatmap()`: Create individual device heatmap with color gradient
- `create_single_heatmap_panel()`: Convert yearly heatmap to table-based layout (in heatmap.py)

### Database Queries
- Added Haiku model filter: `AND (model IS NULL OR LOWER(model) NOT LIKE '%haiku%')`
- Timezone conversion: `strftime('%w', timestamp, 'localtime')`
- Week calculation: Monday-based (Python convention: 0=Monday, 6=Sunday)

### Color System
```python
DEVICE_COLORS = [
    "#ff8800",  # Orange
    "#00d4ff",  # Cyan
    "#ff3366",  # Pink
    "#00ff88",  # Green
    "#bb86fc",  # Purple
    "#ffdd00",  # Yellow
    "#ff6b6b",  # Red
    "#4ecdc4",  # Teal
]
```

## Visual Improvements
- **Cleaner Appearance**: Removed visual noise from text characters in heatmap cells
- **Better Contrast**: 5-step gradient provides clear distinction between usage levels
- **Consistent Styling**: Unified table format across all heatmap views
- **Square Cells**: Balanced cell proportions for more GitHub-like heatmap appearance

## Bug Fixes
- Fixed opacity calculation to show actual usage gradients (0-10% range now visible)
- Corrected device-specific data isolation (each device shows its own usage only)
- Improved color blending formula for accurate gradient representation

---

For installation and usage instructions, see [README.md](../../README.md)
