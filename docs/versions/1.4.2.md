# Version 1.4.2

**Release Date:** 2025-10-23
**Focus:** Multi-device Git Gist sync fixes and statistics accuracy

## Overview

v1.4.2는 Git Gist 동기화 기능의 다중 기기 지원을 완전히 수정한 버전입니다. Gist pull 후 기기별 DB 분리, 대용량 파일 다운로드, 통계 계산 오류 등 여러 critical 이슈를 해결했습니다.

## 주요 변경사항

### 1. Git Gist 동기화 수정

#### 1.1 Sync Metadata 자동 생성 지원
**문제점:**
- `get_db_path()`가 None일 때 (auto-detect 경로) sync_metadata 업데이트 실패
- Gist manifest에 machine이 등록되지 않음 (0 machines)

**해결:**
- `_update_local_sync_metadata()`에서 `get_default_db_path()` fallback 추가
- Auto-detect 경로에서도 gist_id 저장 가능

**파일 변경:**
- `src/sync/sync_manager.py` (378-393줄)

#### 1.2 대용량 파일 다운로드 지원
**문제점:**
- GitHub Gist API는 1MB 이상 파일의 `content` 필드를 truncate
- `is_truncated: true`이지만 content가 빈 문자열이 아닌 경우 감지 실패
- `json.loads()` 에러: "Expecting value: line 1 column 1 (char 0)"

**해결:**
- `is_truncated` 플래그 확인 추가
- `content`가 None이거나 empty인 경우 감지
- `raw_url`에서 직접 다운로드

**파일 변경:**
- `src/sync/gist_client.py` (218-229줄)

**실제 효과:**
- Laptop-WT.db: 15.8 MB 파일 성공적으로 다운로드

#### 1.3 기기별 DB 분리
**문제점:**
- Gist pull 시 모든 기기의 데이터가 현재 기기의 DB로 import됨
- `usage_history.db`에 여러 기기 데이터가 섞임
- Devices 뷰에서 중복/누락 발생

**해결:**
- 각 기기의 JSON 파일을 `usage_history_{machine_name}.db`로 저장
- 예: `usage_history_HOME-WT.db`, `usage_history_Laptop-WT.db`
- 기기별 DB 완전 분리

**파일 변경:**
- `src/sync/sync_manager.py` (208-214줄)

#### 1.4 자동 Machine 등록
**문제점:**
- Gist에서 import한 기기가 `machines.db`에 등록되지 않음
- Devices 뷰에서 invisible

**해결:**
- `import_from_json()` 시 `register_machine()` 자동 호출
- sync_metadata 테이블 자동 생성

**파일 변경:**
- `src/sync/json_import.py` (131-156줄)

### 2. 통계 계산 수정

#### 2.1 Device Statistics 계산 수정
**문제점:**
- Gist pull로 가져온 DB는 `device_monthly_stats` 테이블이 비어있음
- 기존 쿼리는 `device_monthly_stats` + 현재 월만 조회
- 과거 월 데이터 누락 (예: 9월 데이터)

**해결:**
- `device_monthly_stats` 존재 여부 체크
- 비어있으면 전체 `usage_records`에서 계산 (fallback)
- HOME-WT: $1,865.84 + Laptop-WT: $2,186.98 = **$4,052.82** ✅

**파일 변경:**
- `src/storage/snapshot_db.py` (2813-2896줄)

#### 2.2 Yearly/Monthly 뷰 통계 수정
**문제점:**
- `_calculate_totals_for_records()`는 모든 기기 포함
- 그러나 `_create_monthly_breakdown()`이 `summary.daily` 사용
- `summary`는 현재 기기만 포함
- Monthly Usage: 9월 $849.80 + 10월 $1017.29 = $1,867.09 (실제: $4,088.08)

**해결:**
- `use_summary` 로직 완전 제거
- 항상 `records`에서 직접 계산 (모든 기기 포함)
- 9월 $1,904.25 + 10월 $2,183.83 = **$4,088.08** ✅

**파일 변경:**
- `src/visualization/dashboard.py` (2309-2338줄)

---

## 기술적 세부사항

### Git Gist Sync Flow (After v1.4.2)

```
┌─────────────────┐
│ Gist Push       │
├─────────────────┤
│ 1. Export JSON  │  ← Machine-specific JSON (HOME-WT.json, Laptop-WT.json)
│ 2. Upload Gist  │  ← Files >1MB use raw_url for download
│ 3. Update Meta  │  ← Save gist_id to sync_metadata (auto-detect path support)
│ 4. Update Manif │  ← Register machine in manifest
└─────────────────┘
         │
         v
┌─────────────────┐
│ Gist Pull       │
├─────────────────┤
│ 1. Get Manifest │  ← List all machines
│ 2. Download All │  ← Check is_truncated, use raw_url if needed
│ 3. Import Each  │  ← usage_history_{machine_name}.db
│ 4. Register M.  │  ← Auto-register in machines.db
│ 5. Create Table │  ← sync_metadata table if missing
└─────────────────┘
```

### Database Structure (Multi-Device)

```
~/.claude/usage/
├── usage_history_HOME-WT.db     ← HOME-WT 기기 데이터
│   ├── usage_records            (31,041 records)
│   ├── device_monthly_stats     (빈 테이블 - Gist import)
│   └── sync_metadata            (gist_id, last_export_date)
│
├── usage_history_Laptop-WT.db  ← Laptop-WT 기기 데이터
│   ├── usage_records            (32,079 records)
│   ├── device_monthly_stats     (빈 테이블 - Gist import)
│   └── sync_metadata            (없음 - import된 DB)
│
└── machines.db                  ← 기기 목록
    └── machines                 (HOME-WT, Laptop-WT)
```

### Statistics Calculation (Multi-Device)

**Before v1.4.2:**
```python
# ❌ device_monthly_stats만 조회 (과거 월 누락)
SELECT ... FROM device_monthly_stats WHERE machine_name = ?
UNION
SELECT ... FROM usage_records WHERE month = current_month
```

**After v1.4.2:**
```python
# Check if device_monthly_stats has data
if has_monthly_stats:
    # ✅ 기존 로직 (최적화)
    SELECT ... FROM device_monthly_stats + current_month
else:
    # ✅ Fallback: 전체 usage_records 조회
    SELECT ... FROM usage_records WHERE machine_name = ?
```

---

## 실제 사용 예시

### Devices View (수정 전/후)

**Before v1.4.2:**
```
┌─ Devices ─────────────────────────────────────┐
│ Device        Sessions   Cost                 │
│ HOME-WT       2,092      $1,861.53            │
│ Laptop-WT     2,430      $1,132.54  ❌ 누락   │
│ ────────────────────────────────────────────  │
│ Total         4,522      $2,994.07  ❌ 잘못   │
└───────────────────────────────────────────────┘
```

**After v1.4.2:**
```
┌─ Devices ─────────────────────────────────────┐
│ Device        Sessions   Cost                 │
│ HOME-WT       2,092      $1,865.84  ✅        │
│ Laptop-WT     2,430      $2,186.98  ✅        │
│ ────────────────────────────────────────────  │
│ Total         4,522      $4,052.82  ✅        │
└───────────────────────────────────────────────┘
```

### Yearly View - Monthly Usage (수정 전/후)

**Before v1.4.2:**
```
Monthly Usage
Month       Tokens(I/O)       Cache(W/R)     Messages   Cost
2025-09     322.9M / 95.3K    22.2M / 359.5K   4091     $849.80  ❌
2025-10     428.4K / 1.1M     117.9M / 1.1bn  14108    $1017.29  ❌
────────────────────────────────────────────────────────────────
Total                                                  $1,867.09  ❌
```

**After v1.4.2:**
```
Monthly Usage
Month       Tokens(I/O)       Cache(W/R)     Messages   Cost
2025-09     750.2M / 49.5M    485.1M / 1.2bn   8520    $1,904.25  ✅
2025-10     2.1bn / 119.7M    1.8bn / 3.4bn   28277    $2,183.83  ✅
────────────────────────────────────────────────────────────────
Total                                                  $4,088.08  ✅
```

---

## 커밋 내역

### Fix 1: Sync metadata auto-detection support
- `_update_local_sync_metadata()`에서 `get_default_db_path()` fallback 추가
- Auto-detect 경로에서 gist_id 저장 가능

### Fix 2: Large file download from Gist
- `is_truncated` 플래그 체크
- `raw_url`에서 직접 다운로드
- 15.8 MB Laptop-WT 파일 성공

### Fix 3: Machine-specific database separation
- `pull()` 함수 수정
- 각 기기의 JSON → `usage_history_{machine_name}.db`
- DB 완전 분리

### Fix 4: Auto machine registration on import
- `import_from_json()`에서 `register_machine()` 호출
- sync_metadata 테이블 자동 생성

### Fix 5: Device statistics fallback query
- `get_device_statistics()`에서 fallback 로직 추가
- `device_monthly_stats` 비어있으면 `usage_records` 직접 조회
- Devices 뷰 통계 정확도 수정

### Fix 6: Yearly/Monthly view multi-device support
- `_create_monthly_breakdown()`에서 `use_summary` 제거
- 항상 `records`에서 계산 (모든 기기 포함)
- Monthly Usage 정확도 수정

---

## 성능 영향

### Database Query Performance

**Before v1.4.2:**
- Devices 뷰: `device_monthly_stats` 조회 (fast, but incomplete)
- Yearly 뷰: `summary.daily` 조회 (fast, but single device)

**After v1.4.2:**
- Devices 뷰:
  - `device_monthly_stats` 있으면 기존 로직 (fast)
  - 없으면 `usage_records` 전체 조회 (slower, but accurate)
- Yearly 뷰: `records` 직접 계산 (already done before v1.4.2)

**예상 성능:**
- 초기 Gist pull: ~2-5초 느림 (fallback query)
- 이후: `device_monthly_stats` 자동 생성되면 fast
- 사용자 체감 차이: 거의 없음

---

## Breaking Changes

없음 - 하위 호환성 유지

---

## 마이그레이션 가이드

### 기존 사용자 (v1.4.0 - v1.4.1)

1. **최신 버전으로 업데이트:**
   ```bash
   cd /path/to/claude-code-usage-analytics
   git pull origin main
   pipx uninstall claude-code-usage-analytics
   pipx install -e .
   ```

2. **Gist 재동기화 (권장):**
   ```bash
   # 기존 Gist 삭제 (선택)
   ccu gist setup  # 새로운 Gist 생성

   # 또는 기존 Gist 사용
   ccu gist push   # 현재 기기 데이터 업로드
   ccu gist pull   # 다른 기기 데이터 다운로드
   ```

3. **변경사항 확인:**
   ```bash
   ccu
   # [d] 키를 눌러 Devices 뷰 확인 → 모든 기기 표시
   # [y] 키를 눌러 Yearly 뷰 확인 → Monthly Usage 정확도 확인
   ```

---

## 알려진 이슈

### 1. Device Monthly Stats 자동 생성 없음
- Gist에서 가져온 DB는 `device_monthly_stats`가 비어있음
- Fallback query로 해결하지만 약간 느림
- 향후: `ccu` 실행 시 자동 생성 기능 추가 예정

### 2. Gist API Rate Limit
- GitHub API는 시간당 5,000 요청 제한 (인증된 사용자)
- 대용량 파일 많으면 제한 도달 가능
- 해결: 토큰 사용, 요청 throttling

---

## 다음 버전 계획 (v1.5.0)

- [ ] Device monthly stats 자동 생성 (`ccu` 시작 시)
- [ ] Gist sync progress bar (대용량 파일)
- [ ] Incremental sync 최적화 (changed files only)
- [ ] Conflict resolution (동시 push 시)
- [ ] Gist backup/restore 기능

---

## 관련 문서

- [Version 1.4.1](./1.4.1.md) - Weekly 뷰 Opus 독립 리셋
- [Version 1.4.0](./1.4.0.md) - Opus 독립 리셋 시각 처리
- [Git Gist Sync Design](../gist-sync-design.md) - 아키텍처 문서
- [Git Gist Sync Guide](../gist-sync-guide.md) - 사용자 가이드
- [CLAUDE.md](../../CLAUDE.md) - 프로젝트 개발 가이드

---

## 테스트 시나리오

### 1. Multi-Device Sync Test
```bash
# Machine A (HOME-WT)
ccu gist push

# Machine B (Laptop-WT)
ccu gist pull
ccu  # [d] Devices 뷰에서 HOME-WT 확인
```

### 2. Large File Download Test
```bash
# 15+ MB database file
ccu gist pull  # raw_url로 다운로드 확인
```

### 3. Statistics Accuracy Test
```bash
ccu  # [d] Devices 뷰: 총 비용 확인
     # [y] Yearly 뷰: Monthly Usage 합계 확인
     # 두 값이 일치해야 함
```

---

**Contributors:**
- wangtae
- Claude (Co-Authored-By: Claude <noreply@anthropic.com>)

**관련 이슈:**
- Multi-device Gist sync 완전 수정
- Statistics calculation 정확도 개선

**릴리스 노트:**
- v1.4.2는 Git Gist 다중 기기 동기화의 critical 버그를 수정한 중요 릴리스입니다.
- Gist sync 사용자는 **반드시 업데이트**를 권장합니다.
- Devices 뷰와 Yearly 뷰 통계가 정확하게 표시됩니다.
