# Version 1.4.6 Release Notes

**Release Date**: 2025-10-26
**Type**: Bug Fix
**Priority**: Recommended Update

## Overview

Version 1.4.6 fixes a critical bug in the weekly recommended usage percentage calculation. The previous version used a 24-hour window, causing the recommended percentage to incorrectly display 100% after just 24 hours. This release changes the calculation to use the full 7-day period, providing accurate recommended usage throughout the entire week.

---

## 🐛 Bug Fixes

### Weekly Recommended Percentage Calculation

**Issue**: Current week (all models) recommended usage showed 100% after only 24 hours

**Symptoms**:
```
Current week (all models)
████████████████████████████████████████████████████████ 20%
                                                         ↑ 100% 권장
Resets 10/31 ($200.06)
```

**Root Cause**:
- `_calculate_weekly_recommended_pct()` function used 24-hour window calculation
- After 24 hours elapsed, the function returned 100%
- Example: Week started Friday 9:59am, by Saturday 4:45pm (~31 hours elapsed) = 100% recommended
- This was incorrect - recommended usage should be proportional to week progress

**Expected Behavior**:
- Week is 7 days = 10,080 minutes
- After ~31 hours (~1,860 minutes) = 18.4% of week elapsed
- Recommended usage should show 18.4%, not 100%

**Fix**: Changed calculation from 24-hour window to 7-day even distribution

**Files Modified**:
- `src/visualization/dashboard.py` - `_calculate_weekly_recommended_pct()` function (lines 157-298)

**Result**:
- ✅ Recommended usage accurately reflects week progress
- ✅ After 1 day: 14.3% recommended (1/7 of week)
- ✅ After 6 days: 85.7% recommended (6/7 of week)
- ✅ Increases ~0.0099% per minute (1/10,080 per minute)

---

## 🔧 Technical Details

### Calculation Logic Change

**Before (v1.4.5)** - 24-hour window:
```python
# Calculate recommended usage based on 24-hour window
total_minutes_24h = 24 * 60  # 1440 minutes (24 hours)

# Calculate elapsed minutes since week start
elapsed = now - week_start
elapsed_minutes = elapsed.total_seconds() / 60

# After 24 hours, recommended stays at 100%
recommended_pct = (elapsed_minutes / total_minutes_24h) * 100
return min(100, recommended_pct)
```

**After (v1.4.6)** - 7-day even distribution:
```python
# Calculate total period in minutes (always 7 days)
# 7 days × 24 hours × 60 minutes = 10,080 minutes
total_period_minutes = 7 * 24 * 60

# Calculate elapsed minutes since week start
elapsed = now - week_start
elapsed_minutes = elapsed.total_seconds() / 60

# This distributes 100% evenly across the entire 7-day period
# Each minute that passes increases the recommended usage by ~0.0099%
recommended_pct = (elapsed_minutes / total_period_minutes) * 100

return min(100, recommended_pct)
```

### Calculation Formula

**7-day even distribution**:
```
recommended_pct = (elapsed_minutes / 10,080) × 100

Where:
  - total_period = 7 days = 10,080 minutes
  - elapsed_minutes = time since week start
  - recommended_pct = 0-100%
```

### Example Calculations

**Scenario**: Week started Friday 9:59am, current time Saturday 4:45pm

| Time Point | Elapsed | Calculation | Recommended % |
|-----------|---------|-------------|---------------|
| Friday 9:59am | 0 min | (0 / 10,080) × 100 | 0.0% |
| Friday 10:59am | 60 min | (60 / 10,080) × 100 | 0.6% |
| Saturday 9:59am | 1 day | (1,440 / 10,080) × 100 | 14.3% |
| Saturday 4:45pm | ~31h | (~1,860 / 10,080) × 100 | 18.4% |
| Thursday 9:59am | 6 days | (8,640 / 10,080) × 100 | 85.7% |
| Friday 9:59am | 7 days | (10,080 / 10,080) × 100 | 100.0% |

---

## 📊 Impact Analysis

### Affected Components

**Fixed**:
- ✅ Current week (all models) - Now uses 7-day distribution
- ✅ Recommended usage bar - Shows accurate progress throughout week

**Already Correct** (No changes needed):
- ✅ Current week (Opus) - Already used 7-day distribution via `_calculate_distributed_recommended_pct()`
- ✅ Current session - 5-hour rolling window (unchanged)

### Function Comparison

| Function | Used By | Period | Before v1.4.6 | After v1.4.6 |
|----------|---------|--------|---------------|--------------|
| `_calculate_weekly_recommended_pct()` | Current week (all models) | 7 days | ❌ 24-hour window | ✅ 7-day distribution |
| `_calculate_distributed_recommended_pct()` | Current week (Opus) | 7 days | ✅ 7-day distribution | ✅ 7-day distribution |
| `_calculate_session_recommended_pct()` | Current session | 5 hours | ✅ 5-hour window | ✅ 5-hour window |

### Visual Impact

**Before v1.4.6** (Saturday 4:45pm, 31 hours after week start):
```
Current week (all models)
████████████░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░ 20%
                                                         ↑ 100% 권장
Resets 10/31 ($200.06)

❌ Shows 100% recommended after just 1.3 days
```

**After v1.4.6** (Same time):
```
Current week (all models)
████████████░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░ 20%
          ↑ 18.4% 권장
Resets 10/31 ($200.06)

✅ Shows 18.4% recommended (accurate for 1.3 days elapsed)
```

---

## 🎯 Benefits

### 1. Accurate Usage Guidance
- Recommended percentage accurately reflects week progress
- Users can pace usage throughout the week
- Prevents front-loading usage in first 24 hours

### 2. Consistent Visualization
- Both "Current week (all models)" and "Current week (Opus)" now use same logic
- Recommended bar moves smoothly throughout week
- Updates every minute (~0.0099% increment)

### 3. Better Planning
- At day 2: Should have used ~28.6% of quota
- At day 5: Should have used ~71.4% of quota
- Clear visibility into whether usage is ahead or behind pace

---

## 🧪 Testing

### Verification Steps

**Test Case 1**: Verify calculation after 1 day
```python
# Week start: Friday 9:59am
# Current: Saturday 9:59am (24 hours elapsed)
# Expected: 14.3% recommended (1/7 of week)

elapsed_minutes = 24 * 60  # 1440
total_minutes = 7 * 24 * 60  # 10080
recommended = (elapsed_minutes / total_minutes) * 100
# Result: 14.285714...% ≈ 14.3%
```

**Test Case 2**: Verify calculation at specific time
```python
# Week start: Friday 9:59am
# Current: Saturday 4:45pm (30 hours 46 minutes elapsed)
# Expected: ~18.4% recommended

elapsed_minutes = (30 * 60) + 46  # 1846
total_minutes = 7 * 24 * 60  # 10080
recommended = (elapsed_minutes / total_minutes) * 100
# Result: 18.313492...% ≈ 18.3%
```

**Test Case 3**: Verify calculation at week end
```python
# Week start: Friday 9:59am
# Current: Next Friday 9:59am (7 days elapsed)
# Expected: 100% recommended

elapsed_minutes = 7 * 24 * 60  # 10080
total_minutes = 7 * 24 * 60  # 10080
recommended = (elapsed_minutes / total_minutes) * 100
# Result: 100.0%
```

### Manual Testing

```bash
# Run dashboard and observe recommended percentage
ccu

# Expected behavior:
# - Recommended % should match (elapsed_time / 7_days) * 100
# - Should NOT show 100% until week end
# - Should increase ~0.0099% per minute
```

---

## 🚀 Migration Guide

### Automatic Update

No migration required. The fix applies automatically upon upgrade.

**What Changes**:
- Recommended usage bar position will be more accurate
- If you're early in the week, recommended bar will be further left (more accurate)
- If you're late in the week, recommended bar will be in correct position

**Example**: If 2 days have elapsed (28.6% of week):
- **Before**: Showed 100% recommended (incorrect)
- **After**: Shows 28.6% recommended (correct)

---

## 🐛 Known Issues

### None Reported

This release is a targeted bug fix with no new features or breaking changes.

---

## 📚 Documentation Updates

### Updated Files

- `src/visualization/dashboard.py` - Fixed `_calculate_weekly_recommended_pct()` function
- `docs/versions/1.4.6.md` - This release note

### Code Comments

Updated function docstring to reflect new behavior:

```python
def _calculate_weekly_recommended_pct(week_reset_str: str, weekly_days: int) -> float:
    """
    Calculate recommended usage percentage by distributing 100% evenly
    across the entire 7-day period.

    Goal: Distribute quota uniformly over the week period (from week
    start to reset). This provides accurate recommended usage that
    increases proportionally with elapsed time, matching the actual
    weekly usage pattern.

    Returns:
        Recommended usage percentage (0-100) based on elapsed time
        - Increases proportionally as time progresses through the week
        - 1 day elapsed = 14.3% recommended (1/7 of week)
        - 6 days elapsed = 85.7% recommended (6/7 of week)

    Example:
        Week start: Oct 24, 9:59am (Friday)
        Reset: Oct 31, 9:59am (Friday, 7 days later)
        Current: Oct 25, 4:45pm (Saturday, ~31 hours elapsed)

        Total period: 7 days = 10,080 minutes
        Elapsed: ~1.29 days = ~1,857 minutes
        Recommended: (1,857 / 10,080) × 100 ≈ 18.4%
    """
```

---

## 🔗 Related Issues

### Fixed Issues

1. **Weekly recommended usage showing 100% after 24 hours** (User report: 2025-10-26)
   - Symptom: Recommended bar at 100% on day 2 of week
   - Root cause: 24-hour window calculation instead of 7-day distribution
   - Fix: Changed to 7-day even distribution

---

## 👥 Contributors

- **Claude** (claude-sonnet-4-5-20250929) - Bug diagnosis and fix implementation
- **wangt** - Issue reporting, testing, verification

---

## 📦 Upgrade Instructions

### From 1.4.5 to 1.4.6

```bash
# Pull latest code
git fetch origin
git checkout develop
git pull origin develop

# Reinstall (if using pipx)
pipx reinstall claude-code-usage-analytics

# Or if using pip
pip install -e .

# Verify version
python -c "from src.config.settings import VERSION; print(VERSION)"
# Should show: 1.4.6

# Test dashboard
ccu
# Recommended % should now be accurate for week progress
```

### Rollback Instructions

```bash
# If issues occur, rollback to 1.4.5
git checkout v1.4.5

# Reinstall
pipx reinstall claude-code-usage-analytics
# or
pip install -e .
```

---

## 📄 Changelog Summary

```
v1.4.6 (2025-10-26)
-------------------

Fixed:
  - Weekly recommended usage calculation now uses 7-day distribution
  - Recommended percentage accurately reflects week progress
  - Fixed incorrect 100% display after only 24 hours

Changed:
  - _calculate_weekly_recommended_pct() now calculates based on full 7-day period
  - Updated function docstring with accurate examples
  - Calculation now matches _calculate_distributed_recommended_pct() logic

Technical:
  - Changed total_period from 1,440 minutes (24h) to 10,080 minutes (7d)
  - Recommended % increases ~0.0099% per minute
  - Accurate visualization throughout entire week
```

---

## 🏆 Version Comparison

| Metric | v1.4.5 | v1.4.6 | Change |
|--------|--------|--------|--------|
| Weekly Calc Window | 24 hours | 7 days | ✅ Fixed |
| Day 1 Recommended | 100% ❌ | 14.3% ✅ | ✅ Accurate |
| Day 2 Recommended | 100% ❌ | 28.6% ✅ | ✅ Accurate |
| Day 6 Recommended | 100% ❌ | 85.7% ✅ | ✅ Accurate |
| Opus Calculation | ✅ Correct | ✅ Correct | No change |
| Session Calculation | ✅ Correct | ✅ Correct | No change |

---

## 🎓 Technical Deep Dive

### Why 7-Day Distribution?

**Weekly Usage Pattern**:
- Claude Code resets weekly limits every 7 days
- Users should pace usage throughout the week
- Even distribution prevents quota exhaustion

**Calculation Rationale**:
- Total quota = 100%
- Total time = 7 days = 10,080 minutes
- Each minute = 100% / 10,080 = ~0.0099%
- After X minutes: recommended = (X / 10,080) × 100

**Visual Feedback**:
- Gray bar shows recommended usage range
- Blue bar shows actual usage
- Red bar shows exceeded usage (if actual > recommended)

**Example Interpretation**:
```
Current week (all models)
████████████░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░ 20%
          ↑ 18.4% 권장
```
- You've used 20% of quota
- Week is 18.4% complete
- Slightly ahead of pace (+1.6%)
- Still within safe usage range

---

**End of Release Notes**
