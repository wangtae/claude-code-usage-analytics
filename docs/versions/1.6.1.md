# Version 1.6.1

**Release Date:** 2025-11-08
**Focus:** Weekly view cache token display and accurate Opus period filtering

## Overview

v1.6.1은 Weekly view의 Usage Limits에 cache 토큰 표시를 추가하고, Current week (Opus)가 정확한 Opus reset 기간의 데이터를 집계하도록 수정한 버전입니다.

## 주요 변경사항

### 1. Weekly View에 Cache 토큰 표시 추가

#### 1.1 Usage Limits에 Cache 토큰 상세 표시
**문제점:**
- Weekly mode의 Usage Limits에 input/output 토큰만 표시
- Cache write/read 토큰이 표시되지 않음
- Usage Limits의 토큰 수와 Tokens by Model 섹션의 토큰 수가 크게 차이남 (183배 차이)

**해결:**
- Weekly mode에서 모든 limit (Current session, Current week all models, Current week Opus)에 cache 토큰 표시 추가
- 표시 형식: `($cost) [inputI / outputO] (C:writeW / readR)`
- Usage mode에는 cost만 표시 (토큰 상세 정보 없음)

**파일 변경:**
- `src/visualization/dashboard.py` (2159-2207줄)

**표시 예시 (Weekly mode):**
```
Current session (Today $12.34)
███████████████████░░░░░░░░░░░░ 67%
Resets Nov 14, 9:59am (Asia/Seoul) ($12.34) [1.2KI / 5.6KO] (C:100.3KW / 1.2MR)

Current week (all models)
████████████████████████░░░░░░░ 80%
Resets Nov 14, 9:59am (Asia/Seoul) ($107.88) [33.1KI / 561.2KO] (C:10.7MW / 114.6MR)

Current week (Opus)
█████████████████████████████░░ 98%
Resets Nov 10, 11:59am (Asia/Seoul) ($65.73) [15.2KI / 280.3KO] (C:5.3MW / 57.2MR)
```

**범례:**
- `I` = Input tokens
- `O` = Output tokens
- `C:` = Cache tokens
- `W` = Cache Write (creation)
- `R` = Cache Read

### 2. Weekly View Records 필터링 수정

#### 2.1 Opus Reset 기간 전체 포함
**문제점:**
- Weekly view의 records가 `week_reset` 기준으로만 필터링됨
- Opus reset과 Week reset의 시간이 다른 경우 (예: Opus Nov 3 13:59, Week Nov 7 09:59)
- Current week (Opus)가 Opus reset 기간 (Nov 3 ~ Nov 7)의 데이터를 누락
- 결과적으로 Opus 토큰 수가 실제보다 적게 표시됨

**해결:**
- Weekly view에서 세 가지 reset 시간 (Session, Week, Opus) 중 가장 빠른 시간부터 records 필터링
- `get_week_start_datetime("opus_reset")` 호출하여 Opus reset 기간 시작 확인
- 오늘 자정 (session reset)도 확인
- 가장 빠른 시간부터 week_reset_date까지의 모든 records 포함

**파일 변경:**
- `src/commands/usage.py` (1512-1568줄)

**필터링 로직:**
```python
# 1. Week reset: Nov 7, 09:59 → week start: Oct 31, 09:59
# 2. Opus reset: Nov 3, 13:59 → opus week start: Oct 27, 13:59
# 3. Session reset: Nov 8, 00:00

# earliest_week_start = Oct 27, 13:59 (가장 빠름)
# Records: Oct 27, 13:59 ~ Nov 7, 09:59
```

### 3. Timezone 비교 오류 수정

#### 3.1 Offset-naive/aware datetime 비교 오류
**문제점:**
- `adjusted_week_reset_date`가 naive datetime인 경우
- `record_dt`와 비교 시 `TypeError: can't compare offset-naive and offset-aware datetimes`

**해결:**
- `adjusted_week_reset_date`를 UTC timezone-aware로 변환
- `record_dt`도 UTC timezone-aware로 통일
- 모든 datetime을 UTC로 통일하여 비교 가능하게 수정

**파일 변경:**
- `src/commands/usage.py` (1520-1560줄)

#### 3.2 UnboundLocalError 수정
**문제점:**
- Try 블록 안에서 `from datetime import datetime` 중복 import
- 파일 최상단에 이미 import된 `datetime`과 충돌
- `UnboundLocalError: cannot access local variable 'datetime'`

**해결:**
- Try 블록 안의 중복 import 제거
- 파일 최상단의 import 사용

**파일 변경:**
- `src/commands/usage.py` (1541줄)

---

## 기술적 세부사항

### Token 계산 함수 수정

**Before v1.6.1:**
```python
def _calculate_weekly_sonnet_cost(records, week_reset_str):
    # ...
    records = load_recent_usage_records(include_previous_days=30)  # ❌ 내부에서 30일 데이터만 로드
    # ...
    return weekly_cost  # ❌ float만 반환
```

**After v1.6.1:**
```python
def _calculate_weekly_sonnet_cost(records, week_reset_str):
    # ...
    # Use the provided records as-is (already contains full history in weekly view)
    # ...
    return {
        "cost": weekly_cost,
        "input_tokens": input_tokens,
        "output_tokens": output_tokens,
        "cache_creation_tokens": cache_creation_tokens,
        "cache_read_tokens": cache_read_tokens
    }
```

### Weekly View Filter Logic

**Before v1.6.1:**
```python
# Only filter by week_reset
week_reset_date = _parse_week_reset_date(week_reset_str)
display_records = _filter_records_by_week(all_records, adjusted_week_reset_date)
# → Nov 7, 09:59 ~ now only
```

**After v1.6.1:**
```python
# Find earliest reset time among Session, Week, Opus
earliest_week_start = adjusted_week_reset_date - timedelta(days=7)  # Default

opus_week_start_dt = get_week_start_datetime("opus_reset")
if opus_week_start_dt and opus_week_start_dt < earliest_week_start:
    earliest_week_start = opus_week_start_dt

# Filter from earliest to week_reset_date
if earliest_week_start <= record_dt < week_end:
    filtered.append(record)
# → Oct 27, 13:59 ~ Nov 7, 09:59 (includes full Opus period)
```

---

## 실제 사용 예시

### Before v1.6.1

**Usage Limits (Weekly mode):**
```
Current week (all models)
████████████████████████░░░░░░░ 80%
Resets Nov 14, 9:59am (Asia/Seoul) ($107.88) [33.1K / 561.2K]  ❌ Cache tokens missing

Current week (Opus)
█████████████████████████████░░ 98%
Resets Nov 10, 11:59am (Asia/Seoul) ($65.73) [15.2K / 280.3K]  ❌ Cache tokens missing
```

**Token Discrepancy:**
- Usage Limits: 595K tokens (I/O only)
- Tokens by Model: 125.9M tokens (I/O + cache)
- Difference: 212x ❌

### After v1.6.1

**Usage Limits (Weekly mode):**
```
Current week (all models)
████████████████████████░░░░░░░ 80%
Resets Nov 14, 9:59am (Asia/Seoul) ($107.88) [33.1KI / 561.2KO] (C:10.7MW / 114.6MR)  ✅

Current week (Opus)
█████████████████████████████░░ 98%
Resets Nov 10, 11:59am (Asia/Seoul) ($65.73) [15.2KI / 280.3KO] (C:5.3MW / 57.2MR)  ✅
```

**Token Match:**
- Usage Limits: 125.9M tokens (I/O + cache)
- Tokens by Model: 126.0M tokens (I/O + cache)
- Difference: 0.1M (0.08%) ✅

---

## 커밋 내역

### Commit 1: Add cache token display to weekly view Usage Limits
- `_calculate_session_cost()` 반환 타입 변경: float → dict (cost + tokens)
- `_calculate_weekly_sonnet_cost()` 반환 타입 변경: float → dict
- `_calculate_weekly_opus_cost()` 반환 타입 변경: float → dict
- Weekly mode 섹션 (line 2140-2213)에 cache 토큰 표시 추가
- Usage mode에는 cost만 표시 유지

### Commit 2: Fix weekly view records filtering for Opus reset period
- Weekly view에서 세 가지 reset 중 가장 빠른 시간부터 필터링
- `get_week_start_datetime("opus_reset")` 호출 추가
- Opus reset 기간 전체 데이터 포함

### Commit 3: Fix timezone comparison errors
- `adjusted_week_reset_date`를 UTC timezone-aware로 변환
- `record_dt`도 UTC로 통일
- UnboundLocalError 수정 (중복 import 제거)

---

## Breaking Changes

없음 - 하위 호환성 유지

---

## 마이그레이션 가이드

### 기존 사용자 (v1.6.0)

1. **최신 버전으로 업데이트:**
   ```bash
   cd /path/to/claude-code-usage-analytics
   git pull origin main
   pipx uninstall claude-code-usage-analytics
   pipx install -e .
   ```

2. **변경사항 확인:**
   ```bash
   ccu
   # [w] 키를 눌러 weekly 모드 진입
   # Usage Limits에서 cache 토큰이 표시되는지 확인
   # Usage Limits와 Tokens by Model의 토큰 수가 일치하는지 확인
   ```

3. **추가 설정 불필요** - 자동으로 cache 토큰 표시

---

## 알려진 이슈

없음

---

## 다음 버전 계획 (v1.7.0)

- [ ] Monthly/Yearly 뷰에도 cache 토큰 표시 추가
- [ ] Heatmap에 cache 토큰 표시
- [ ] Cost breakdown by cache type (write vs read)

---

## 성능 및 최적화

- 계산 오버헤드: 무시할 수 있는 수준 (dict 반환으로 인한 약간의 메모리 증가)
- Records 필터링: 가장 빠른 reset 기간부터 로드하므로 약간 더 많은 데이터 포함 (정확도 향상)
- 렌더링 성능: Cache 토큰 표시로 인한 문자열 길이 증가 (미미함)

---

## 관련 문서

- [Version 1.6.0](./1.6.0.md) - Recent 7 Days mode 추가
- [Version 1.4.2](./1.4.2.md) - Multi-device Git Gist sync fixes
- [Version 1.4.1](./1.4.1.md) - Weekly view Opus reset time fix
- [CLAUDE.md](../../CLAUDE.md) - 프로젝트 개발 가이드
- [README.md](../../README.md) - 사용자 문서

---

## 테스트 시나리오

### 1. Cache Token Display Test
```bash
ccu
# [w] 키 눌러 weekly mode 진입
# Usage Limits에서 (C:xxxW / xxxR) 형식 확인
# [u] 키 눌러 usage mode 진입
# Usage Limits에서 cost만 표시되는지 확인
```

### 2. Token Accuracy Test
```bash
ccu
# [w] 키 눌러 weekly mode 진입
# Usage Limits의 토큰 수 (I/O + cache) 확인
# Tokens by Model의 토큰 수 확인
# 두 값이 일치하는지 확인 (오차 1% 이하)
```

### 3. Opus Period Test
```bash
ccu
# [w] 키 눌러 weekly mode 진입
# Current week (Opus) 토큰 수 확인
# Opus reset 날짜 확인 (예: Nov 3, 13:59)
# Week reset 날짜 확인 (예: Nov 7, 09:59)
# Opus 토큰 수가 Nov 3 ~ now 기간 전체를 포함하는지 확인
```

---

**Contributors:**
- wangtae
- Claude (Co-Authored-By: Claude <noreply@anthropic.com>)

**관련 이슈:**
- Weekly view cache token display
- Opus reset period filtering accuracy

**릴리스 노트:**
- v1.6.1은 Weekly view의 cache 토큰 표시와 Opus reset 기간 필터링을 개선한 버전입니다.
- Weekly mode를 자주 사용하는 사용자는 업데이트를 권장합니다.
- Usage Limits와 Tokens by Model의 토큰 수가 정확하게 일치합니다.
