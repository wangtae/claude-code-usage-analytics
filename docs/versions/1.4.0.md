# Version 1.4.0

**Release Date:** 2025-10-23
**Focus:** Separate reset time handling for Opus limits

## Overview

이번 릴리스는 Current week (all models)와 Current week (Opus)가 서로 다른 리셋 시각을 가질 때 권장 사용률이 잘못 계산되던 문제를 수정했습니다. 이제 각 한도는 독립적인 리셋 시각을 기반으로 정확한 권장 사용률을 표시합니다.

## 주요 변경사항

### Opus 권장 사용률 독립 계산

**문제점:**
- Current week (all models)와 Current week (Opus)가 서로 다른 리셋 시각을 가짐:
  - `week_reset`: "10am (Asia/Seoul)" - 내일 리셋
  - `opus_reset`: "Oct 27, 11:59am (Asia/Seoul)" - 4일 후 리셋
- 그러나 두 한도 모두 `weekly_recommended_pct`(week_reset 기반)를 사용하여 권장 바를 표시
- 결과적으로 리셋 시각이 다름에도 불구하고 동일한 권장 사용률 표시

**해결:**
- `opus_recommended_pct` 계산 로직 추가 - `opus_reset` 시각 기반
- 모든 디스플레이 모드(M1, M2, M3, M4)에서 Opus는 자체 `opus_recommended_pct` 사용
- 각 한도가 독립적인 리셋 시각에 따라 정확한 권장 사용률 표시

**파일 변경:**
- `src/visualization/dashboard.py`: opus_recommended_pct 계산 추가 및 모든 모드에 적용

**효과:**
- Current week (all models): 자체 리셋 시각 기반 권장 바 (예: 87% 경과)
- Current week (Opus): 독립적인 리셋 시각 기반 권장 바 (예: 43% 경과)
- 차이가 명확히 시각화되어 사용자가 각 한도의 상태를 정확히 파악 가능

---

## 기술적 세부사항

### 권장 사용률 계산 정확도

**1분 단위 계산 확인:**
```python
# src/visualization/dashboard.py:273
elapsed_minutes = elapsed.total_seconds() / 60  # 초 단위를 분으로 변환
recommended_pct = (elapsed_minutes / total_minutes) * 100
```

**테스트 결과:**
- 1초당 약 0.000166% 증가
- 1분당 약 0.01% 증가
- 매 분마다 새로고침 시 권장 바가 조금씩 오른쪽으로 이동

### Before (v1.3.9)

```python
# Parse week reset time to calculate elapsed days
weekly_recommended_pct = 0
if limits.get('week_reset'):
    weekly_recommended_pct = _calculate_weekly_recommended_pct(limits['week_reset'], weekly_days)

# ❌ 문제: Opus도 같은 weekly_recommended_pct 사용
# Opus limit
limits_table.add_row("Current week (Opus)")

# Opus uses same weekly recommended percentage as "all models"  ❌
if weekly_recommended_pct > 0:
    opus_bar = _create_usage_bar_with_recommended(
        limits["opus_pct"],
        weekly_recommended_pct,  # ❌ week_reset 기반 (잘못됨)
        width=bar_width,
        color_mode=color_mode,
        colors=colors
    )
```

### After (v1.4.0)

```python
# Parse week reset time to calculate elapsed days
weekly_recommended_pct = 0
if limits.get('week_reset'):
    weekly_recommended_pct = _calculate_weekly_recommended_pct(limits['week_reset'], weekly_days)

# ✅ 추가: Opus 전용 권장 사용률 계산
# Parse opus reset time to calculate elapsed days (separate from week reset)
opus_recommended_pct = 0
if limits.get('opus_reset'):
    opus_recommended_pct = _calculate_weekly_recommended_pct(limits['opus_reset'], weekly_days)

# Opus limit
limits_table.add_row("Current week (Opus)")

# Opus uses its own reset time (opus_reset) which may differ from week_reset  ✅
if opus_recommended_pct > 0:
    opus_bar = _create_usage_bar_with_recommended(
        limits["opus_pct"],
        opus_recommended_pct,  # ✅ opus_reset 기반 (올바름)
        width=bar_width,
        color_mode=color_mode,
        colors=colors
    )
```

---

## 실제 사용 예시

### 현재 시각 기준 계산 결과

**시나리오:**
- 현재 시각: 2025-10-23 12:04PM (Asia/Seoul)
- Current week (all models) reset: "10am (Asia/Seoul)" → 내일 오전 10시
- Current week (Opus) reset: "Oct 27, 11:59am (Asia/Seoul)" → 4일 후

**계산 결과:**

| 한도 | 리셋 시각 | 권장 사용률 | 실제 사용률 | 상태 |
|------|----------|------------|------------|------|
| Current week (all models) | 10am (내일) | 87.21% | 63% | ✅ 정상 (회색 권장 바) |
| Current week (Opus) | Oct 27, 11:59am | 43.17% | 100% | ⚠️ 초과 (빨간색 초과 바) |

**차이: 44.04%** - 이제 각 한도가 독립적으로 계산됩니다!

### 시각적 표현

**Before (v1.3.9):**
```
Current week (all models)
████████████████████████████████████████████░░░░░░░░░░░░░ 63%
Resets 10am ($235.25)

Current week (Opus)
████████████████████████████████████████████████████████ 100%  ❌ 동일한 권장 바
Resets 10/27 ($99.97)
```

**After (v1.4.0):**
```
Current week (all models)
███████████████████████████████████░░░░░░░░░░░░░░░░░░░░░ 63%
                                   ↑ 87% 권장
Resets 10am ($235.25)

Current week (Opus)
█████████████████████░░░░░■■■■■■■■■■■■■■■■■■■■■■■■■■■■■ 100%  ✅ 독립적인 권장 바
                     ↑ 43% 권장   ↑ 초과 (빨간색)
Resets 10/27 ($99.97)
```

범례:
- `█` (파란색): 현재 사용량
- `░` (회색): 권장 사용 범위 (아직 사용 안 함)
- `■` (빨간색): 권장 초과 사용량

---

## 커밋 내역

### f1907e5 - Fix: Use separate reset times for Opus recommended usage calculation

- `opus_recommended_pct` 계산 추가 (opus_reset 사용, week_reset 아님)
- Current week (all models)와 Current week (Opus)가 이제 독립적인 리셋 시각 사용
- 모든 디스플레이 모드(M1, M2, M3, M4)에서 Opus 바가 opus_recommended_pct 사용

**변경 전:** 둘 다 weekly_recommended_pct 사용 (잘못됨)
**변경 후:** 각자 자신의 리셋 시각 사용 (올바름)

**예시:**
- Current week reset: "10am" → 87% 권장
- Opus reset: "Oct 27, 11:59am" → 43% 권장

**영향받은 파일:**
- `src/visualization/dashboard.py`:
  - opus_recommended_pct 계산 로직 추가 (680-683번 줄)
  - M1 모드 Opus 바 수정 (736-743번 줄)
  - M2 모드 Opus 바 수정 (808-815번 줄)
  - M3 모드 Opus 바 수정 (875-882번 줄)
  - M4 모드 Opus 바 수정 (950-957번 줄)

---

## 사용자 영향

### 1. 정확한 진행 상황 파악
- 각 한도가 자체 리셋 시각에 따라 독립적으로 표시됨
- Opus 사용이 주간 한도보다 빠르게 증가하는지 한눈에 파악 가능

### 2. 더 나은 사용 계획
- Current week (all models): 내일 리셋 → "오늘 중 63%까지만 써도 안전"
- Current week (Opus): 4일 후 리셋 → "이미 권장량(43%) 초과, 주의 필요"

### 3. 실시간 권장 바 업데이트
- 1분마다 권장 바가 조금씩 이동
- 시간 경과에 따른 사용 권장량 변화를 시각적으로 확인

---

## 마이그레이션 가이드

### 기존 사용자

1. 최신 버전으로 업데이트:
   ```bash
   cd /path/to/claude-code-usage-analytics
   git pull origin develop
   pipx uninstall claude-code-usage-analytics
   pipx install -e .
   ```

2. 변경사항 확인:
   ```bash
   ccu
   # Current week (Opus) 바가 이제 독립적인 권장 바를 표시
   ```

3. 추가 설정 불필요 - 자동으로 올바른 리셋 시각 사용

---

## 알려진 이슈

없음

---

## Breaking Changes

없음 - 하위 호환성 유지

---

## 다음 버전 계획

- [ ] 커스텀 주간 권장 일수 설정 UI 개선
- [ ] 권장 사용률 초과 시 알림 옵션
- [ ] 디바이스별 권장 사용률 표시

---

## 성능 및 최적화

- 계산 오버헤드: 무시할 수 있는 수준 (단일 datetime 계산 추가)
- 메모리 사용량: 변화 없음
- 렌더링 성능: 영향 없음

---

## 테스트 결과

### 권장 사용률 계산 정확도 테스트

```bash
$ python3 -c "from src.visualization.dashboard import _calculate_weekly_recommended_pct; print(_calculate_weekly_recommended_pct('10am (Asia/Seoul)', 7))"
87.21%

$ python3 -c "from src.visualization.dashboard import _calculate_weekly_recommended_pct; print(_calculate_weekly_recommended_pct('Oct 27, 11:59am (Asia/Seoul)', 7))"
43.17%
```

### 1분 단위 증가 테스트

```bash
Testing minute-by-minute changes:
  Attempt 1: 87.197525%
  Attempt 2: 87.197691%  (+0.000166% per second)
  Attempt 3: 87.197856%  (+0.000166% per second)

Difference per minute: approximately 0.00992% (1분당 약 0.01%)
```

✅ 모든 테스트 통과

---

## 관련 문서

- [Version 1.3.9](./1.3.9.md) - 색상 모드 수정 및 버전 관리 개선
- [CLAUDE.md](../../CLAUDE.md) - 프로젝트 개발 가이드
- [README.md](../../README.md) - 사용자 문서

---

**Contributors:**
- wangtae
- Claude (Co-Authored-By: Claude <noreply@anthropic.com>)

**관련 이슈:**
- 없음 (사용자 피드백 기반 개선)

**릴리스 노트:**
- v1.4.0은 권장 사용률 표시의 정확도를 크게 개선한 마이너 버전 업데이트입니다.
- 기존 사용자는 업데이트 후 즉시 개선된 권장 바를 확인할 수 있습니다.
