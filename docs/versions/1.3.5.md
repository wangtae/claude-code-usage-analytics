# Version 1.3.5

**Release Date**: 2025-10-22

## New Features

### Git Gist Conflict Prevention & Auto-Merge
- **Automatic conflict detection** when multiple devices push simultaneously
- **Smart auto-merge** resolves conflicts without user intervention (up to 3 retries)
- **Timestamp-based conflict resolution** compares manifest versions
- **Force push option** (`--force`) to skip conflict detection when needed

### Storage Mode Display Enhancement
- **"Local" always shown as base** - clarifies that DB is always stored locally
- **Cloud sync shown additively** - "Local + OneDrive", "Local + Git Gist", etc.
- **Accurate representation** of multi-sync setups

### Git Gist Backup Status in Settings
- **Unified backup view** - See both local and Gist backups in Settings
- **Last Gist Sync** - Shows last sync time and record count
- **Cached status** - Fast display (60-second cache, no API delay)
- **Auto-detection** - Only shows if Git Gist is configured

## Changes

### Manifest Enhancements
Added timestamp comparison methods:
- `get_last_updated()` - Returns manifest's last_updated timestamp
- `is_newer_than(timestamp)` - Checks if manifest is newer than given timestamp
- `merge_with(other_manifest)` - Intelligently merges two manifests

Merge strategy:
- Per-machine entries: Keep the one with most recent `last_sync`
- Backup lists: Combine and deduplicate
- Global timestamp: Use the newer `last_updated`

### SyncManager Conflict Resolution
New method: `_detect_and_resolve_conflict(local_manifest, retry_count)`
- Workflow:
  1. Download latest manifest from Gist
  2. Compare timestamps
  3. If remote is newer ‚Üí Merge manifests ‚Üí Retry
  4. Maximum 3 retry attempts
  5. If all retries fail ‚Üí Raise ConflictError

Updated `push()` method:
- New parameter: `skip_conflict_check` (for `--force` flag)
- Integrated conflict detection before upload
- Returns conflict resolution status in stats

### Command Line Interface
Updated `ccu gist push` command:
- **Changed**: `--force` / `-f` now means "force push, skip conflict detection"
- **New**: `--export-all` flag for exporting all data (not incremental)
- **Improved error messages**: Clear suggestions when conflicts can't be resolved

### Exception Handling
New exception classes in `src/sync/exceptions.py`:
- `ConflictError` - Cannot auto-resolve conflict after max retries
- `SyncError` - Generic synchronization error (base class)
- `TokenError` - Invalid or missing GitHub token
- `ManifestError` - Corrupted or invalid manifest

### User Messages

**During successful auto-merge:**
```
Pushing to Gist...
‚ö†Ô∏è  Conflict detected: Gist has newer changes
   Local:  2025-10-22T10:30:00Z
   Remote: 2025-10-22T10:31:00Z
üîÑ Auto-merging... (attempt 1/3)
‚úì Done
‚úì Conflicts auto-resolved via merge
```

**When auto-merge fails:**
```
‚úó Conflict Error

Cannot auto-resolve conflict after 3 retries.
Remote Gist has newer changes from another device.
Run 'ccu gist pull' to sync latest data, then push again.
Or use 'ccu gist push --force' to override (may lose data).

Suggestions:
  1. Run ccu gist pull to sync latest data, then push again
  2. Or use ccu gist push --force to override (may lose data)
```

## Technical Details

### Settings Display Enhancement
Added Git Gist backup information to Settings screen:
- New helper function: `_get_gist_backup_info()` with 60-second cache
- Status table now shows:
  - "Last Local Backup" - Local automatic backups
  - "Last Gist Sync" - Git Gist cloud backups (if configured)
- Smart display logic:
  - Shows "Not synced yet" if Gist configured but never synced
  - Hides row if Gist not configured (clean UI)
  - Formats timestamp: "2025-10-21 14:32 (27,325 records)"

### Files Modified
1. `src/commands/settings.py`
   - Updated `_detect_storage_mode()` to always show "Local" as base
   - Added `_get_gist_backup_info()` helper function with caching
   - Updated status table to show both local and Gist backups
   - Changed "Last Backup" ‚Üí "Last Local Backup"
   - Added "Last Gist Sync" row (conditional)

2. `src/sync/manifest.py`
   - Added `get_last_updated()` method
   - Added `is_newer_than(timestamp)` method
   - Added `merge_with(other_manifest)` method

3. `src/sync/sync_manager.py`
   - Added `_detect_and_resolve_conflict()` method
   - Updated `push()` with conflict detection
   - Added `skip_conflict_check` parameter
   - Imported `ConflictError` exception

4. `src/commands/gist_cmd.py`
   - Updated `push()` command signature
   - Changed `--force` flag meaning (conflict skip, not export-all)
   - Added `--export-all` flag
   - Added `ConflictError` exception handling

### Files Created
1. `src/sync/exceptions.py` - Custom exception classes

### Documentation Updates
1. `docs/gist-sync-design.md` - Added "Concurrency Control" section
2. `docs/versions/1.3.5.md` - This file

## Benefits

### For Users
- **Zero-configuration conflict resolution** - Works automatically
- **Data safety** - Auto-merge prevents data loss
- **Clear feedback** - Knows when conflicts occur and how they're resolved
- **Manual override** - `--force` flag when needed

### For Multi-Device Workflows
- **Simultaneous push supported** - No more "wait for other device to finish"
- **Automatic synchronization** - Devices merge their manifests intelligently
- **Reduced errors** - Fewer "push rejected" errors

## Use Cases

### Scenario 1: Two Devices Push at Same Time
```
Home PC:   push at 10:30:00 ‚Üí success
Office PC: push at 10:30:01 ‚Üí conflict detected ‚Üí auto-merge ‚Üí success
```

### Scenario 2: One Device Has Older Data
```
Laptop (offline for 2 days): push ‚Üí detect newer remote ‚Üí merge ‚Üí success
```

### Scenario 3: Conflict Can't Be Resolved
```
PC-A: push ‚Üí conflict ‚Üí retry 3 times ‚Üí fail ‚Üí user runs pull ‚Üí push ‚Üí success
```

## Breaking Changes

**None**. This is a backwards-compatible enhancement.

Existing behavior:
- `ccu gist push` - Still works, now with conflict detection
- `ccu gist pull` - Unchanged

New behavior:
- `ccu gist push --force` - Changed meaning (conflict skip)
- `ccu gist push --export-all` - New flag (old `--force` behavior)

## Migration Guide

If you were using `--force` flag to export all data:
- **Before**: `ccu gist push --force` (export all + force overwrite)
- **After**: `ccu gist push --export-all` (export all with conflict detection)
- **After**: `ccu gist push --export-all --force` (export all + skip conflict check)

## Known Limitations

1. **Race Condition Window**: Small time window between timestamp check and upload
   - Very rare, would require simultaneous push within milliseconds
   - If occurs, retry will resolve it

2. **Not Truly Atomic**: GitHub Gist API doesn't support compare-and-swap
   - Auto-merge is best-effort, not guaranteed atomic
   - Extremely rare cases may require manual resolution

3. **Max 3 Retries**: If conflict persists after 3 attempts, manual intervention required
   - Suggests running `ccu gist pull` + `ccu gist push`
   - Or using `--force` to override

## Future Improvements

- Exponential backoff between retry attempts
- Per-record deduplication in merge strategy
- Conflict resolution UI for manual decision-making
- Optimistic locking with ETag headers (if GitHub API supports)

## Compatibility

- **Python**: 3.10+
- **Dependencies**: No new dependencies
- **Git Gist**: Works with existing Gists (no migration needed)
- **Manifests**: Backwards compatible (uses existing `last_updated` field)

## Testing Recommendations

1. Test with two devices pushing simultaneously:
   ```bash
   # Device 1
   ccu gist push

   # Device 2 (run immediately after)
   ccu gist push
   ```

2. Verify auto-merge messages appear

3. Test force push:
   ```bash
   ccu gist push --force
   ```

4. Test manual conflict resolution:
   ```bash
   # If auto-merge fails
   ccu gist pull
   ccu gist push
   ```
