# Version 1.4.8 Release Notes

**Release Date**: 2025-10-27
**Type**: Bug Fix + Feature Enhancement
**Priority**: Recommended Update

## Overview

Version 1.4.8 fixes critical issues with weekly reset time parsing and Opus cost calculation. The previous versions had problems with inconsistent `claude /usage` output formats and filtered record sets, causing incorrect or missing cost displays. This release introduces persistent reset time storage with incremental updates and ensures accurate cost calculations across all view modes.

---

## ğŸ› Bug Fixes

### 1. Weekly Opus Cost Showing $0.00

**Issue**: Weekly mode displayed `$0.00` for "Current week (Opus)" cost

**Symptoms**:
```
Current week (Opus)
â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ 100%
Resets 12pm (Asia/Seoul) ($0.00)
```

**Root Causes**:
1. **Inconsistent `claude /usage` output**: Sometimes shows full date+time, sometimes date only, sometimes time only
2. **No persistent storage**: Reset times were parsed each time but not stored
3. **Information loss**: Time-only or date-only outputs lost critical information
4. **Filtered records**: Weekly mode passed filtered (7-day) records to cost functions, missing data outside that range
5. **Reset period mismatch**: Opus reset period (e.g., Oct 20-27) differed from weekly view period (e.g., Oct 24-27)

**Expected Behavior**:
- Opus weekly cost should display accurate amount (e.g., $280.96)
- Cost should be consistent across Usage and Weekly modes
- Should work regardless of `claude /usage` output format

**Fix**:
1. Created persistent reset time storage system
2. Implemented incremental update mechanism
3. Modified cost calculation functions to reload full dataset when needed

**Result**:
- âœ… Opus cost displays correctly in all modes
- âœ… Works with any `claude /usage` output format
- âœ… Consistent calculations across Usage/Weekly modes

---

### 2. Reset Time Parsing Fragility

**Issue**: Reset time parsing failed when `claude /usage` returned incomplete information

**Symptoms**:
- Sometimes got "Oct 27, 9:59am (Asia/Seoul)" - full info âœ…
- Sometimes got "Oct 27 (Asia/Seoul)" - date only, no time âŒ
- Sometimes got "9:59am (Asia/Seoul)" - time only, no date âŒ
- Each incomplete parse caused calculation errors

**Root Cause**:
- No storage mechanism to preserve previously known information
- Each parse attempt started from scratch
- Incomplete data caused fallback to inaccurate 7-day lookback

**Fix**: Persistent storage with incremental updates

**Result**:
- âœ… Date-only update preserves existing time
- âœ… Time-only update preserves existing date
- âœ… Full update refreshes all information
- âœ… Always maintains complete reset time data

---

## ğŸš€ New Features

### Persistent Reset Time Storage

**File**: `~/.claude/claude-goblin-mod/reset_times.json`

**Structure**:
```json
{
  "session_reset": {
    "date": "2025-10-27",
    "time": "14:00",
    "timezone": "Asia/Seoul",
    "full_string": "2pm (Asia/Seoul)"
  },
  "week_reset": {
    "date": "2025-10-31",
    "time": "10:00",
    "timezone": "Asia/Seoul",
    "full_string": "Oct 31, 10am (Asia/Seoul)"
  },
  "opus_reset": {
    "date": "2025-10-27",
    "time": "12:00",
    "timezone": "Asia/Seoul",
    "full_string": "12pm (Asia/Seoul)"
  },
  "last_updated": "2025-10-27T10:52:26.565387"
}
```

**Features**:
- Stores session, week (all models), and opus reset times separately
- Includes date, time, timezone, and original string
- Persists across application restarts
- Updates incrementally as new information arrives

---

## ğŸ”§ Technical Implementation

### Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ claude /usage (inconsistent output)                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚ Parse & Store
                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ~/.claude/claude-goblin-mod/reset_times.json             â”‚
â”‚ - session_reset: {date, time, timezone}                  â”‚
â”‚ - week_reset: {date, time, timezone}                     â”‚
â”‚ - opus_reset: {date, time, timezone}                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚ Use stored data
                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Cost Calculation Functions                               â”‚
â”‚ - get_week_start_datetime()                              â”‚
â”‚ - load_recent_usage_records(30 days)                     â”‚
â”‚ - Accurate cost calculation                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Files Added

**`src/config/reset_times.py`** (NEW):
- `load_reset_times()` - Load from disk
- `save_reset_times()` - Save to disk
- `parse_reset_string()` - Parse various formats
- `update_reset_time()` - Incremental update
- `get_reset_datetime()` - Get as datetime object
- `get_week_start_datetime()` - Calculate week start
- `format_reset_for_display()` - Format for UI

### Files Modified

**`src/commands/limits.py`**:
- `capture_limits()` now stores parsed reset times (lines 190-215)
- Uses stored values for display if available
- Falls back to parsed values if storage fails

**`src/visualization/dashboard.py`**:
- `_calculate_weekly_opus_cost()` (lines 1530-1565):
  - Tries stored reset time first
  - Loads full recent records (30 days) when using stored time
  - Prevents data loss from filtered record sets
- `_calculate_weekly_sonnet_cost()` (lines 1391-1429):
  - Same improvements as opus function
  - Ensures accurate "all models" cost calculation

### Incremental Update Logic

**Example Scenario**:

1. **First run**: `claude /usage` returns "Oct 27, 11:59am (Asia/Seoul)"
   ```json
   {
     "opus_reset": {
       "date": "2025-10-27",
       "time": "11:59",
       "timezone": "Asia/Seoul"
     }
   }
   ```

2. **Later**: `claude /usage` returns "12pm (Asia/Seoul)" (time only)
   ```json
   {
     "opus_reset": {
       "date": "2025-10-27",        // â† Preserved
       "time": "12:00",              // â† Updated
       "timezone": "Asia/Seoul"      // â† Updated
     }
   }
   ```

3. **Later**: `claude /usage` returns "Oct 27 (Asia/Seoul)" (date only)
   ```json
   {
     "opus_reset": {
       "date": "2025-10-27",        // â† Confirmed/updated
       "time": "12:00",              // â† Preserved
       "timezone": "Asia/Seoul"
     }
   }
   ```

---

## ğŸ§ª Testing

### Test Results

**Test 1**: Parsing various formats
```python
# Time only: "11:59am (Asia/Seoul)"
# Result: time="11:59", timezone="Asia/Seoul", date=None âœ…

# Full format: "Oct 27, 9:59am (Asia/Seoul)"
# Result: date="2025-10-27", time="09:59", timezone="Asia/Seoul" âœ…

# Numeric date: "10/27 9:59am (Asia/Seoul)"
# Result: date="2025-10-27", time="09:59", timezone="Asia/Seoul" âœ…

# Date only: "Oct 31 (Asia/Seoul)"
# Result: date="2025-10-31", timezone="Asia/Seoul", time=None âœ…
```

**Test 2**: Incremental updates
```python
# Step 1: Time-only update
update_reset_time('opus_reset', '11:59am (Asia/Seoul)')
# Result: date=None, time="11:59" âœ…

# Step 2: Date update (preserves time)
update_reset_time('opus_reset', 'Oct 27 (Asia/Seoul)')
# Result: date="2025-10-27", time="11:59" âœ…

# Step 3: Full update
update_reset_time('opus_reset', 'Oct 27, 11:59am (Asia/Seoul)')
# Result: date="2025-10-27", time="11:59" âœ…
```

**Test 3**: Week start calculation
```python
# Stored: date="2025-10-27", time="11:59", timezone="Asia/Seoul"
week_start = get_week_start_datetime('opus_reset')
# Result: 2025-10-20 11:59:00+09:00 (7 days before reset) âœ…
```

**Test 4**: Cost calculation
```python
# With empty records (should load internally)
opus_cost = _calculate_weekly_opus_cost([], None)
# Result: $280.96 âœ…

# With filtered records (should reload internally)
filtered = load_recent_usage_records(include_previous_days=3)
opus_cost = _calculate_weekly_opus_cost(filtered, None)
# Result: $280.96 (same as above) âœ…
```

---

## ğŸ“Š Impact Analysis

### Before v1.4.8

**Usage Mode**:
```
Current week (Opus)
â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ 100%
Resets 11:59am (Asia/Seoul) ($280.96)
```
âœ… Works (had stored full string)

**Weekly Mode**:
```
Current week (Opus)
â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ 100%
Resets 12pm (Asia/Seoul) ($0.00)
```
âŒ Shows $0.00 (filtered records + parsing issues)

### After v1.4.8

**Usage Mode**:
```
Current week (Opus)
â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ 100%
Resets 12pm (Asia/Seoul) ($280.96)
```
âœ… Works correctly

**Weekly Mode**:
```
Current week (Opus)
â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ 100%
Resets 12pm (Asia/Seoul) ($280.96)
```
âœ… Now shows correct cost!

---

## ğŸ¯ Benefits

### 1. Reliability
- Works regardless of `claude /usage` output format
- Persistent storage prevents data loss
- Graceful handling of incomplete information

### 2. Accuracy
- Correct cost calculations in all view modes
- Full dataset used for weekly cost calculations
- No data loss from filtered record sets

### 3. Consistency
- Same Opus cost displayed in Usage and Weekly modes
- Session, Week (all models), and Opus reset times tracked separately
- Timezone-aware calculations throughout

### 4. Maintainability
- Clean separation of concerns (storage, parsing, calculation)
- Comprehensive error handling
- Future-proof against `claude /usage` format changes

---

## ğŸš€ Migration Guide

### Automatic Migration

No manual steps required. The system will:
1. Create `~/.claude/claude-goblin-mod/reset_times.json` on first run
2. Parse and store reset times from next `claude /usage` call
3. Build complete reset time data incrementally

### What You'll See

**First Run**:
- Dashboard fetches limits as usual
- New `reset_times.json` file created
- Initial reset times stored

**Subsequent Runs**:
- Stored reset times used for calculations
- Display shows most complete information available
- Incremental updates preserve existing data

**No Breaking Changes**:
- Existing workflows unchanged
- All commands work exactly as before
- Only internal improvements

---

## ğŸ“š Documentation Updates

### New Documentation

- `src/config/reset_times.py` - Comprehensive docstrings
- Function-level documentation for all new features
- Examples in docstrings

### Updated Documentation

- `src/commands/limits.py` - Updated capture_limits() docs
- `src/visualization/dashboard.py` - Updated cost calculation docs
- This release note (`docs/versions/1.4.8.md`)

---

## ğŸ”— Related Issues

### Fixed Issues

1. **Weekly mode Opus cost showing $0.00** (User report: 2025-10-27)
   - Symptom: $0.00 displayed despite actual usage
   - Root cause: Filtered records + parsing issues
   - Fix: Persistent storage + full record reload

2. **Inconsistent cost displays** (Discovered during fix)
   - Symptom: Different costs in Usage vs Weekly modes
   - Root cause: Different record sets used for calculation
   - Fix: Consistent record loading logic

3. **Reset time parsing failures** (Root cause analysis)
   - Symptom: Calculations fall back to 7-day lookback
   - Root cause: `claude /usage` format variations
   - Fix: Incremental update mechanism

---

## ğŸ† Version Comparison

| Feature | v1.4.7 | v1.4.8 | Change |
|---------|--------|--------|--------|
| Reset Time Storage | âŒ None | âœ… Persistent | NEW |
| Incremental Updates | âŒ N/A | âœ… Yes | NEW |
| Opus Cost (Usage) | âœ… Correct | âœ… Correct | No change |
| Opus Cost (Weekly) | âŒ $0.00 | âœ… Correct | FIXED |
| Parsing Reliability | âš ï¸ Fragile | âœ… Robust | IMPROVED |
| Cross-Mode Consistency | âŒ No | âœ… Yes | FIXED |

---

## ğŸ“¦ Upgrade Instructions

### From 1.4.7 to 1.4.8

```bash
# Pull latest code
git fetch origin
git checkout develop
git pull origin develop

# Reinstall (if using pipx)
pipx install -e . --force

# Or if using pip
pip install -e .

# Verify installation
ccu --version

# Test dashboard
ccu
# Opus cost should now display correctly in all modes
```

### Verification Steps

1. **Check Reset Times Storage**:
   ```bash
   cat ~/.claude/claude-goblin-mod/reset_times.json
   # Should show session_reset, week_reset, opus_reset
   ```

2. **Test Usage Mode**:
   ```bash
   ccu
   # Press 'u' to enter Usage mode
   # Check "Current week (Opus)" cost - should show actual amount
   ```

3. **Test Weekly Mode**:
   ```bash
   ccu
   # Press 'w' to enter Weekly mode
   # Check "Current week (Opus)" cost - should match Usage mode
   ```

---

## ğŸ› Known Issues

### None Reported

This release is a targeted bug fix with comprehensive testing. All known issues have been resolved.

---

## ğŸ‘¥ Contributors

- **Claude** (claude-sonnet-4-5-20250929) - Issue diagnosis, implementation, testing
- **wangt** - Issue reporting, requirements clarification, verification

---

## ğŸ“„ Changelog Summary

```
v1.4.8 (2025-10-27)
-------------------

Added:
  - Persistent reset time storage system (reset_times.json)
  - Incremental update mechanism for reset times
  - src/config/reset_times.py module
  - Week start datetime calculation functions
  - Display formatting functions

Fixed:
  - Weekly mode Opus cost showing $0.00
  - Cost calculation with filtered record sets
  - Reset time parsing from inconsistent claude /usage output
  - Cross-mode cost display inconsistencies

Changed:
  - _calculate_weekly_opus_cost() loads full dataset when using stored times
  - _calculate_weekly_sonnet_cost() loads full dataset when using stored times
  - capture_limits() stores parsed reset times
  - Cost functions prioritize stored reset times over parsed strings

Improved:
  - Parsing reliability with multiple format support
  - Data persistence across application restarts
  - Timezone handling for reset times
  - Error handling for incomplete data
```

---

## ğŸ“ Technical Deep Dive

### Why Persistent Storage?

**Problem with Parsing Approach**:
```
Run 1: claude /usage â†’ "Oct 27, 11:59am" â†’ Parse OK âœ…
Run 2: claude /usage â†’ "11:59am"         â†’ Missing date âŒ
Run 3: claude /usage â†’ "Oct 27"          â†’ Missing time âŒ
```

**Solution with Storage**:
```
Run 1: Parse "Oct 27, 11:59am" â†’ Store {date, time} âœ…
Run 2: Parse "11:59am"         â†’ Update {time}, keep {date} âœ…
Run 3: Parse "Oct 27"          â†’ Update {date}, keep {time} âœ…
```

### Why Reload Full Records?

**Problem with Filtered Records**:
```
Weekly View Period:  Oct 24 10am â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Oct 31 10am
                           â”‚                            â”‚
Opus Reset Period:   Oct 20 12pm â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Oct 27 12pm
                     â†‘                     â†‘
                     Missing!              OK
```

**Solution: Reload Full Dataset**:
```python
if use_stored_time:
    # Don't trust provided records - may be filtered
    records = load_recent_usage_records(include_previous_days=30)
    # Now have ALL data for accurate calculation
```

### Why Three Separate Reset Times?

**Different Reset Schedules**:
- **Session**: 5-hour rolling window
- **Week (all models)**: Weekly reset (e.g., Friday 10am)
- **Opus**: Separate weekly reset (e.g., Monday 12pm)

**All three can differ**, requiring separate tracking.

---

**End of Release Notes**
