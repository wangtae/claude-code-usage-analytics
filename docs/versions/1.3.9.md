# Version 1.3.9

**Release Date:** 2025-10-23
**Focus:** Color mode fixes and version management improvements

## Overview

이번 릴리스는 gradient 색상 모드가 의도치 않게 사용되던 문제를 수정하고, 버전 관리를 중앙화하며, 주간 권장 사용률 표시 기능을 개선했습니다.

## 주요 변경사항

### 1. 색상 모드 수정 (Solid Mode)

**문제점:**
- 설정 메뉴에서 gradient 모드(G1-4)를 제거했음에도 불구하고 기본 색상 모드가 여전히 gradient로 설정되어 있었음
- 사용 현황 바가 3가지 색상(파란색, 주황색, 분홍색)으로 표시되고 있었음

**해결:**
- 기본 `color_mode`를 `"gradient"` → `"solid"`로 변경
- 색상 정의를 재구성하여 solid 모드 색상을 명확히 구분
- Gradient 관련 색상은 하위 호환성을 위해 legacy 섹션으로 이동

**파일 변경:**
- `src/config/defaults.py`: 기본 색상 모드 및 색상 정의 재구성

**효과:**
- 이제 모든 진행 바가 단일 파란색(#B1B9f9)으로 표시됨
- 권장 사용률은 회색(grey46)으로 표시
- 초과 사용은 빨간색(#ff4444)으로 강조

---

### 2. 버전 관리 중앙화

**문제점:**
- 버전 정보가 여러 곳에 중복 정의되어 있었음:
  - `pyproject.toml`: 1.3.7
  - `src/commands/usage.py`: 하드코딩 "1.3.7"
  - `src/commands/settings.py`: 중복된 읽기 로직
- 시작 화면과 설정 화면에서 버전이 다르게 표시될 수 있었음

**해결:**
- `src/utils/_system.py`에 `get_version()` 유틸리티 함수 추가
- `pyproject.toml`에서 버전을 동적으로 읽어오도록 수정
- 모든 중복 코드 제거 및 중앙 집중식 버전 관리 구현

**파일 변경:**
- `src/utils/_system.py`: `get_version()` 함수 추가
- `src/commands/usage.py`: 하드코딩된 버전 제거, `get_version()` 사용
- `src/commands/settings.py`: 중복 로직 제거, `get_version()` 사용
- `pyproject.toml`: 버전 1.3.8 → 1.3.9

**효과:**
- 버전이 한 곳(`pyproject.toml`)에서만 관리됨
- 모든 화면에서 일관된 버전 표시
- Editable 모드 설치 시 버전이 즉시 반영됨

---

### 3. 주간 권장 사용률 표시 개선

**문제점:**
- `week_reset`이 날짜 없이 시간만 표시될 때(예: "9:59am (Asia/Seoul)") 권장 사용률이 계산되지 않았음
- Claude의 `/usage` 명령어는 7일 이내 리셋은 "9:59am"처럼 시간만 표시하고, 그 이후는 "Oct 27, 9:59am"처럼 날짜를 포함함
- Current week (all models)와 Current week (Opus)에서 권장 사용률 바가 표시되지 않았음

**해결:**
- `_calculate_weekly_recommended_pct()` 함수에 시간만 있는 형식 지원 추가
- 날짜가 없을 때 다음 발생 시각을 7일 이내에서 찾도록 수정
- 올바른 주간 권장 사용률 계산 구현

**파일 변경:**
- `src/visualization/dashboard.py`: 시간 전용 형식 파싱 로직 추가

**효과:**
- Current week (all models): 회색 권장 바 정상 표시
- Current week (Opus): 초과 시 빨간색 바 표시
- 분당 권장 진행률 기반으로 정확한 사용률 안내

---

## 커밋 내역

### c591926 - Fix: Change default color mode from gradient to solid
- 기본 color_mode를 'solid'로 변경 (기존 'gradient')
- 색상 정의 재구성 및 명확화
- Gradient 색상을 legacy 섹션으로 이동
- Solid 모드는 단일 색상(#B1B9f9)과 권장/초과 표시 사용

**영향받은 파일:**
- `src/config/defaults.py`: 색상 모드 및 색상 정의 수정

### 55aeb29 - Refactor: Centralize version management to pyproject.toml
- `src/utils/_system.py`에 `get_version()` 유틸리티 함수 추가
- `src/commands/usage.py`에서 하드코딩된 버전 "1.3.7" 제거
- `src/commands/settings.py`의 버전 읽기 로직을 `get_version()` 사용으로 리팩토링
- `pyproject.toml`의 버전을 1.3.8로 업데이트

**영향받은 파일:**
- `src/utils/_system.py`: 새 함수 추가
- `src/commands/usage.py`: 버전 관리 개선
- `src/commands/settings.py`: 중복 코드 제거
- `pyproject.toml`: 버전 업데이트

### c8000f9 - Fix: Support time-only format for weekly reset calculations
- 날짜 없는 week_reset 처리 (예: "9:59am (Asia/Seoul)")
- Claude는 7일 이내 리셋을 시간만 표시
- 7일 윈도우 내에서 다음 리셋 시각 찾기
- 주간 한도에 대한 권장 사용률 바 미표시 문제 수정

**영향받은 파일:**
- `src/visualization/dashboard.py`: 시간 전용 형식 파싱 추가

---

## 기술적 세부사항

### 색상 모드 구조

**Before (v1.3.8):**
```python
DEFAULT_PREFERENCES = {
    "color_mode": "gradient",  # ❌ 문제
    ...
}

DEFAULT_COLORS = {
    "color_solid": "#B1B9f9",
    "color_gradient_low": "#B1B9f9",   # 파란색 (0-60%)
    "color_gradient_mid": "#FFC10C",   # 주황색 (60-85%)
    "color_gradient_high": "#FF1744",  # 빨간색 (85-100%)
    ...
}
```

**After (v1.3.9):**
```python
DEFAULT_PREFERENCES = {
    "color_mode": "solid",  # ✅ 수정
    ...
}

DEFAULT_COLORS = {
    # Solid mode colors (실제 사용)
    "color_solid": "#B1B9f9",
    "color_unfilled": "#505370",
    "color_recommended": "grey46",
    "color_exceeded": "#ff4444",

    # Legacy gradient colors (하위 호환성)
    "color_gradient_low": "#B1B9f9",   # (legacy)
    "color_gradient_mid": "#FFC10C",   # (legacy)
    "color_gradient_high": "#FF1744",  # (legacy)
    ...
}
```

### 버전 관리 구조

**Before (v1.3.8):**
```python
# src/commands/usage.py
version = "1.3.7"  # ❌ 하드코딩

# src/commands/settings.py
try:
    import tomllib
    pyproject_path = Path(__file__).parent.parent.parent / "pyproject.toml"
    with open(pyproject_path, "rb") as f:
        pyproject_data = tomllib.load(f)
        version = pyproject_data.get("project", {}).get("version", "Unknown")
except Exception:
    version = "0.2.0"  # ❌ 중복 로직
```

**After (v1.3.9):**
```python
# src/utils/_system.py
def get_version() -> str:
    """Get version from pyproject.toml."""
    try:
        import tomllib
        pyproject_path = Path(__file__).parent.parent.parent / "pyproject.toml"
        with open(pyproject_path, "rb") as f:
            pyproject_data = tomllib.load(f)
            return pyproject_data.get("project", {}).get("version", "Unknown")
    except Exception:
        return "Unknown"

# src/commands/usage.py
from src.utils._system import get_version
version = get_version()  # ✅ 중앙화

# src/commands/settings.py
from src.utils._system import get_version
version = get_version()  # ✅ 중앙화
```

### 주간 리셋 시간 파싱

**Before (v1.3.8):**
```python
# 날짜가 있는 형식만 지원
date_match = re.search(r'([A-Za-z]+)\s+(\d+),\s+(\d+):?(\d*)(am|pm)', reset_no_tz)
if not date_match:
    return 0  # ❌ 시간만 있으면 실패
```

**After (v1.3.9):**
```python
# 날짜가 있는 형식 시도
date_match = re.search(r'([A-Za-z]+)\s+(\d+),\s+(\d+):?(\d*)(am|pm)', reset_no_tz)

# 날짜 없으면 시간만 파싱 ✅
if not date_match:
    time_match = re.search(r'(\d+):?(\d*)(am|pm)', reset_no_tz)
    if not time_match:
        return 0

    # 오늘 날짜 + 주어진 시간 사용
    hour = int(time_match.group(1))
    minute = int(time_match.group(2)) if time_match.group(2) else 0
    meridiem = time_match.group(3)

    # 24시간 형식 변환
    if meridiem == 'pm' and hour != 12:
        hour += 12
    elif meridiem == 'am' and hour == 12:
        hour = 0

    # 다음 발생 시각 찾기 (7일 이내)
    now = datetime.now(tz)
    reset_dt = now.replace(hour=hour, minute=minute, second=0, microsecond=0)

    while reset_dt < now:
        reset_dt = reset_dt + timedelta(days=1)
        if (reset_dt - now).days > 7:
            break
```

---

## 사용자 영향

### 1. 시각적 변화
- **진행 바**: 3가지 색상 → 단일 파란색
- **권장 사용률**: 회색 바로 표시
- **초과 사용**: 빨간색으로 강조

### 2. 버전 표시
- 모든 화면에서 일관된 버전 번호 표시
- Editable 모드 설치 시 즉시 반영

### 3. 권장 사용률 정확도
- 주간 한도에 대한 정확한 권장 사용률 표시
- 분당 권장 진행률 기반 계산

---

## 마이그레이션 가이드

### 기존 사용자
1. 최신 버전으로 업데이트:
   ```bash
   cd /path/to/claude-code-usage-analytics
   git pull origin main
   pipx uninstall claude-code-usage-analytics
   pipx install -e .
   ```

2. 색상 모드 확인:
   ```bash
   ccu config show
   # color_mode가 "solid"인지 확인
   ```

3. 필요시 데이터베이스 색상 모드 변경:
   ```python
   from src.storage.snapshot_db import save_user_preference
   save_user_preference('color_mode', 'solid')
   ```

---

## 알려진 이슈

없음

---

## 다음 버전 계획

- [ ] Gist 동기화 안정성 개선
- [ ] 디바이스별 통계 성능 최적화
- [ ] 추가 디스플레이 모드 개선

---

**Contributors:**
- wangtae
- Claude (Co-Authored-By: Claude <noreply@anthropic.com>)

**관련 이슈:**
- 없음 (내부 개선)

**관련 문서:**
- [CLAUDE.md](../../CLAUDE.md) - 프로젝트 개발 가이드
- [README.md](../../README.md) - 사용자 문서
